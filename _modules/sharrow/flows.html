

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sharrow.flows &#8212; v2.6.0</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sharrow-docs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="icon" sizes="32x32" type="image/png" href="../../_static/favicon.png" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/sharrow/flows';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search these docs..."
         aria-label="Search these docs..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Getting Started</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../walkthrough/index.html">User Guide</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/one-dim.html">Sharrow Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/two-dim.html">Multi-Dimensional Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/encoding.html">Data Encoding</a></li>

<li class="toctree-l2"><a class="reference internal" href="../../walkthrough/sparse.html">Using Sparse MAZ Skims</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Reference</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ActivitySim/sharrow" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ActivitySim/sharrow/issues/new?title=Issue%20on%20page%20%2F_modules/sharrow/flows.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <h1>Source code for sharrow.flows</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">from</span> <span class="nn">._infer_version</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">.aster</span> <span class="kn">import</span> <span class="n">expression_for_numba</span><span class="p">,</span> <span class="n">extract_all_name_tokens</span><span class="p">,</span> <span class="n">extract_names_2</span>
<span class="kn">from</span> <span class="nn">.filewrite</span> <span class="kn">import</span> <span class="n">blacken</span><span class="p">,</span> <span class="n">rewrite</span>
<span class="kn">from</span> <span class="nn">.relationships</span> <span class="kn">import</span> <span class="n">DataTree</span>
<span class="kn">from</span> <span class="nn">.table</span> <span class="kn">import</span> <span class="n">Table</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sharrow&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CacheMissWarning</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">well_known_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;nb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;np&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pd&quot;</span><span class="p">,</span>
    <span class="s2">&quot;xr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pa&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;log1p&quot;</span><span class="p">,</span>
    <span class="s2">&quot;expm1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;max&quot;</span><span class="p">,</span>
    <span class="s2">&quot;min&quot;</span><span class="p">,</span>
    <span class="s2">&quot;piece&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hard_sigmoid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transpose_leading&quot;</span><span class="p">,</span>
    <span class="s2">&quot;clip&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get&quot;</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">one_based</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">zero_based</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert any string into a similar python identifier.</span>

<span class="sd">    If any modification of the string is made, or if the string</span>
<span class="sd">    is longer than 120 characters, it is truncated and a hash of the</span>
<span class="sd">    original string is added to the end, to ensure every</span>
<span class="sd">    string maps to a unique cleaned name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : str</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cleaned : str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">cleaned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\W|^(?=\d)&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cleaned</span> <span class="o">!=</span> <span class="n">s</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleaned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">:</span>
        <span class="c1"># digest size 15 creates a 24 character base32 string</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span>
            <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="n">digest_size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">cleaned</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cleaned</span><span class="p">[:</span><span class="mi">90</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">cleaned</span>


<span class="k">def</span> <span class="nf">presorted</span><span class="p">(</span><span class="n">sortable</span><span class="p">,</span> <span class="n">presort</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort a collection, with certain items appearing first.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sortable : Collection</span>
<span class="sd">        Elements to sort.</span>
<span class="sd">    presort : Iterable, optional</span>
<span class="sd">        Pre-sorted elements, which are yielded first, in this order,</span>
<span class="sd">        if they appear in `sortable`.</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    Any</span>
<span class="sd">        The elements of sortable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sortable</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">presort</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">presort</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">queue</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">j</span>
                <span class="n">queue</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">queue</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">i</span>


<span class="k">def</span> <span class="nf">_flip_flop_def</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;# sharrow:&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;# sharrow:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span>


<span class="n">well_known_names</span> <span class="o">|=</span> <span class="p">{</span>
    <span class="s2">&quot;_args&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_inputs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_outputs&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">ARG_NAMES</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;_arg</span><span class="si">{</span><span class="n">n</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)}</span>
<span class="n">well_known_names</span> <span class="o">|=</span> <span class="n">ARG_NAMES</span>


<span class="k">def</span> <span class="nf">filter_name_tokens</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">matchable_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">name_tokens</span> <span class="o">=</span> <span class="n">extract_all_name_tokens</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
    <span class="n">arg_tokens</span> <span class="o">=</span> <span class="n">name_tokens</span> <span class="o">&amp;</span> <span class="n">ARG_NAMES</span>
    <span class="n">name_tokens</span> <span class="o">-=</span> <span class="n">well_known_names</span>
    <span class="k">if</span> <span class="n">matchable_names</span><span class="p">:</span>
        <span class="n">name_tokens</span> <span class="o">&amp;=</span> <span class="n">matchable_names</span>
    <span class="k">return</span> <span class="n">name_tokens</span><span class="p">,</span> <span class="n">arg_tokens</span>


<span class="k">class</span> <span class="nc">ExtractOptionalGetTokens</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optional_get_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required_get_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_names</span> <span class="o">=</span> <span class="n">from_names</span>

    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Attribute</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;get&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_names</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">required_get_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                        <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="k">elif</span> <span class="p">(</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                                    <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;default&quot;</span>
                                <span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">optional_get_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                        <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.get with unexpected keyword arguments&quot;</span>
                                    <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ast</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">optional_get_tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                                <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.get with more than 2 positional arguments&quot;</span>
                            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">AST</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">node_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">node_iter</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optional_get_tokens</span>


<span class="k">def</span> <span class="nf">coerce_to_range_index</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">idx</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Int64Index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Float64Index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">UInt64Index</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">is_monotonic_increasing</span> <span class="ow">and</span> <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idx</span>


<span class="n">FUNCTION_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2"># </span><span class="si">{init_expr}</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=False,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def </span><span class="si">{fname}</span><span class="s2">(</span>
<span class="s2">    </span><span class="si">{argtokens}</span>
<span class="s2">    _outputs,</span>
<span class="s2">    </span><span class="si">{nametokens}</span>
<span class="s2">):</span>
<span class="s2">    return </span><span class="si">{expr}</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="n">IRUNNER_1D_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def irunner(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    mask=None,</span>
<span class="s2">):</span>
<span class="s2">    result = np.empty((argshape[0], </span><span class="si">{len_self_raw_functions}</span><span class="s2">), dtype=dtype)</span>
<span class="s2">    if mask is not None:</span>
<span class="s2">        assert mask.ndim == 1</span>
<span class="s2">        assert mask.shape[0] == argshape[0]</span>
<span class="s2">    for j0 in nb.prange(argshape[0]):</span>
<span class="s2">        if mask is not None:</span>
<span class="s2">            if not mask[j0]:</span>
<span class="s2">                result[j0, :] = np.nan</span>
<span class="s2">                continue</span>
<span class="s2">        linemaker(result[j0], j0, </span><span class="si">{joined_namespace_names}</span><span class="s2">)</span>
<span class="s2">    return result</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">IRUNNER_2D_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def irunner(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    mask=None,</span>
<span class="s2">):</span>
<span class="s2">    result = np.empty((argshape[0], argshape[1], </span><span class="si">{len_self_raw_functions}</span><span class="s2">), dtype=dtype)</span>
<span class="s2">    if mask is not None:</span>
<span class="s2">        assert mask.ndim == 2</span>
<span class="s2">        assert mask.shape[0] == argshape[0]</span>
<span class="s2">        assert mask.shape[1] == argshape[1]</span>
<span class="s2">    for j0 in nb.prange(argshape[0]):</span>
<span class="s2">        for j1 in range(argshape[1]):</span>
<span class="s2">            if mask is not None:</span>
<span class="s2">                if not mask[j0, j1]:</span>
<span class="s2">                    result[j0, j1, :] = np.nan</span>
<span class="s2">            linemaker(result[j0, j1], j0, j1, </span><span class="si">{joined_namespace_names}</span><span class="s2">)</span>
<span class="s2">    return result</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">IDOTTER_1D_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def idotter(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    dotarray=None,</span>
<span class="s2">):</span>
<span class="s2">    if dotarray is None:</span>
<span class="s2">        raise ValueError(&quot;dotarray cannot be None&quot;)</span>
<span class="s2">    assert dotarray.ndim == 2</span>
<span class="s2">    result = np.empty((argshape[0], dotarray.shape[1]), dtype=dtype)</span>
<span class="s2">    if argshape[0] &gt; 1000:</span>
<span class="s2">        for j0 in nb.prange(argshape[0]):</span>
<span class="s2">            intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            np.dot(intermediate, dotarray, out=result[j0,:])</span>
<span class="s2">    else:</span>
<span class="s2">        intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">        for j0 in range(argshape[0]):</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            np.dot(intermediate, dotarray, out=result[j0,:])</span>
<span class="s2">    return result</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">IDOTTER_2D_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def idotter(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    dotarray=None,</span>
<span class="s2">):</span>
<span class="s2">    if dotarray is None:</span>
<span class="s2">        raise ValueError(&quot;dotarray cannot be None&quot;)</span>
<span class="s2">    assert dotarray.ndim == 2</span>
<span class="s2">    result = np.empty((argshape[0], argshape[1], dotarray.shape[1]), dtype=dtype)</span>
<span class="s2">    if argshape[0] &gt; 1000:</span>
<span class="s2">        for j0 in nb.prange(argshape[0]):</span>
<span class="s2">          for j1 in range(argshape[1]):</span>
<span class="s2">            intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            np.dot(intermediate, dotarray, out=result[j0,j1,:])</span>
<span class="s2">    else:</span>
<span class="s2">        intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">        for j0 in range(argshape[0]):</span>
<span class="s2">          for j1 in range(argshape[1]):</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            np.dot(intermediate, dotarray, out=result[j0,j1,:])</span>
<span class="s2">    return result</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">ILINER_1D_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=False,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def linemaker(</span>
<span class="s2">    intermediate, j0,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">):</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">ILINER_2D_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=False,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def linemaker(</span>
<span class="s2">    intermediate, j0, j1,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">):</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="n">MNL_GENERIC_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def _sample_choices_maker(</span>
<span class="s2">        prob_array,</span>
<span class="s2">        random_array,</span>
<span class="s2">        out_choices,</span>
<span class="s2">        out_choice_probs,</span>
<span class="s2">):</span>
<span class="s2">    &#39;&#39;&#39;</span>
<span class="s2">    Random sample of alternatives.</span>

<span class="s2">    Parameters</span>
<span class="s2">    ----------</span>
<span class="s2">    prob_array : array of float, shape (n_alts)</span>
<span class="s2">    random_array : array of float, shape (n_samples)</span>
<span class="s2">    out_choices : array of int, shape (n_samples) output</span>
<span class="s2">    out_choice_probs : array of float, shape (n_samples) output</span>

<span class="s2">    &#39;&#39;&#39;</span>
<span class="s2">    sample_size = random_array.size</span>
<span class="s2">    n_alts = prob_array.size</span>

<span class="s2">    random_points = np.sort(random_array)</span>
<span class="s2">    a = 0</span>
<span class="s2">    s = 0</span>
<span class="s2">    unique_s = 0</span>
<span class="s2">    z = 0.0</span>
<span class="s2">    for a in range(n_alts):</span>
<span class="s2">        z += prob_array[a]</span>
<span class="s2">        while s &lt; sample_size and z &gt; random_points[s]:</span>
<span class="s2">            out_choices[s] = a</span>
<span class="s2">            out_choice_probs[s] = prob_array[a]</span>
<span class="s2">            s += 1</span>
<span class="s2">        if s &gt;= sample_size:</span>
<span class="s2">            break</span>
<span class="s2">    if s &lt; sample_size:</span>
<span class="s2">        # rare condition, only if a random point is greater than 1 (a bug)</span>
<span class="s2">        # or if the sum of probabilities is less than 1 and a random point</span>
<span class="s2">        # is greater than that sum, which due to the limits of numerical</span>
<span class="s2">        # precision can technically happen</span>
<span class="s2">        a = n_alts-1</span>
<span class="s2">        while prob_array[a] &lt; 1e-30 and a &gt; 0:</span>
<span class="s2">            # slip back to the last choice with non-trivial prob</span>
<span class="s2">            a -= 1</span>
<span class="s2">        while s &lt; sample_size:</span>
<span class="s2">            out_choices[s] = a</span>
<span class="s2">            out_choice_probs[s] = prob_array[a]</span>
<span class="s2">            s += 1</span>



<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def _sample_choices_maker_counted(</span>
<span class="s2">        prob_array,</span>
<span class="s2">        random_array,</span>
<span class="s2">        out_choices,</span>
<span class="s2">        out_choice_probs,</span>
<span class="s2">        out_pick_count,</span>
<span class="s2">):</span>
<span class="s2">    &#39;&#39;&#39;</span>
<span class="s2">    Random sample of alternatives.</span>

<span class="s2">    Parameters</span>
<span class="s2">    ----------</span>
<span class="s2">    prob_array : array of float, shape (n_alts)</span>
<span class="s2">    random_array : array of float, shape (n_samples)</span>
<span class="s2">    out_choices : array of int, shape (n_samples) output</span>
<span class="s2">    out_choice_probs : array of float, shape (n_samples) output</span>
<span class="s2">    out_pick_count : array of int, shape (n_samples) output</span>

<span class="s2">    &#39;&#39;&#39;</span>
<span class="s2">    sample_size = random_array.size</span>
<span class="s2">    n_alts = prob_array.size</span>

<span class="s2">    random_points = np.sort(random_array)</span>
<span class="s2">    a = 0</span>
<span class="s2">    s = 0</span>
<span class="s2">    unique_s = -1</span>
<span class="s2">    z = 0.0</span>
<span class="s2">    out_pick_count[:] = 0</span>
<span class="s2">    for a in range(n_alts):</span>
<span class="s2">        z += prob_array[a]</span>
<span class="s2">        if s &lt; sample_size and z &gt; random_points[s]:</span>
<span class="s2">            unique_s += 1</span>
<span class="s2">        while s &lt; sample_size and z &gt; random_points[s]:</span>
<span class="s2">            out_choices[unique_s] = a</span>
<span class="s2">            out_choice_probs[unique_s] = prob_array[a]</span>
<span class="s2">            out_pick_count[unique_s] += 1</span>
<span class="s2">            s += 1</span>
<span class="s2">        if s &gt;= sample_size:</span>
<span class="s2">            break</span>
<span class="s2">    if s &lt; sample_size:</span>
<span class="s2">        # rare condition, only if a random point is greater than 1 (a bug)</span>
<span class="s2">        # or if the sum of probabilities is less than 1 and a random point</span>
<span class="s2">        # is greater than that sum, which due to the limits of numerical</span>
<span class="s2">        # precision can technically happen</span>
<span class="s2">        a = n_alts-1</span>
<span class="s2">        while prob_array[a] &lt; 1e-30 and a &gt; 0:</span>
<span class="s2">            # slip back to the last choice with non-trivial prob</span>
<span class="s2">            a -= 1</span>
<span class="s2">        if out_choices[unique_s] != a:</span>
<span class="s2">            unique_s += 1</span>
<span class="s2">        while s &lt; sample_size:</span>
<span class="s2">            out_choices[unique_s] = a</span>
<span class="s2">            out_choice_probs[unique_s] = prob_array[a]</span>
<span class="s2">            out_pick_count[unique_s] += 1</span>
<span class="s2">            s += 1</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">MNL_1D_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">MNL_GENERIC_TEMPLATE</span>
    <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">logit_ndims = 1</span>

<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def mnl_transform_plus1d(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    dotarray=None,</span>
<span class="s2">    random_draws=None,</span>
<span class="s2">    pick_counted=False,</span>
<span class="s2">    logsums=False,</span>
<span class="s2">    choice_dtype=np.int32,</span>
<span class="s2">    pick_count_dtype=np.int32,</span>
<span class="s2">    mask=None,</span>
<span class="s2">):</span>
<span class="s2">    if dotarray is None:</span>
<span class="s2">        raise ValueError(&quot;dotarray cannot be None&quot;)</span>
<span class="s2">    assert dotarray.ndim == 2</span>
<span class="s2">    if mask is not None:</span>
<span class="s2">        assert mask.ndim == 1</span>
<span class="s2">        assert mask.shape[0] == argshape[0]</span>
<span class="s2">    result = np.full((argshape[0], random_draws.shape[1]), -1, dtype=choice_dtype)</span>
<span class="s2">    result_p = np.zeros((argshape[0], random_draws.shape[1]), dtype=dtype)</span>
<span class="s2">    if pick_counted:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], random_draws.shape[1]), dtype=pick_count_dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], 0), dtype=pick_count_dtype)</span>
<span class="s2">    if logsums:</span>
<span class="s2">        _logsums = np.zeros((argshape[0], ), dtype=dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        _logsums = np.zeros((0, ), dtype=dtype)</span>
<span class="s2">    for j0 in nb.prange(argshape[0]):</span>
<span class="s2">            if mask is not None:</span>
<span class="s2">                if not mask[j0]:</span>
<span class="s2">                    continue</span>
<span class="s2">            intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            dotprod = np.dot(intermediate, dotarray)</span>
<span class="s2">            shifter = np.max(dotprod)</span>
<span class="s2">            partial = np.exp(dotprod - shifter)</span>
<span class="s2">            local_sum = np.sum(partial)</span>
<span class="s2">            partial /= local_sum</span>
<span class="s2">            if logsums:</span>
<span class="s2">                _logsums[j0] = np.log(local_sum) + shifter</span>
<span class="s2">            if pick_counted:</span>
<span class="s2">                _sample_choices_maker_counted(partial, random_draws[j0], result[j0], result_p[j0], pick_count[j0])</span>
<span class="s2">            else:</span>
<span class="s2">                _sample_choices_maker(partial, random_draws[j0], result[j0], result_p[j0])</span>
<span class="s2">    return result, result_p, pick_count, _logsums</span>

<span class="s2">&quot;&quot;&quot;</span>
<span class="p">)</span>
<span class="c1"># @nb.jit(</span>
<span class="c1">#     cache=True,</span>
<span class="c1">#     parallel=True,</span>
<span class="c1">#     error_model=&#39;{error_model}&#39;,</span>
<span class="c1">#     boundscheck={boundscheck},</span>
<span class="c1">#     nopython={nopython},</span>
<span class="c1">#     fastmath={fastmath})</span>
<span class="c1"># def mnl_transform_plus1d(</span>
<span class="c1">#     argshape,</span>
<span class="c1">#     {joined_namespace_names}</span>
<span class="c1">#     dtype=np.{dtype},</span>
<span class="c1">#     dotarray=None,</span>
<span class="c1">#     random_draws=None,</span>
<span class="c1">#     pick_counted=False,</span>
<span class="c1">#     logsums=False,</span>
<span class="c1">#     choice_dtype=np.int32,</span>
<span class="c1">#     pick_count_dtype=np.int32,</span>
<span class="c1"># ):</span>
<span class="c1">#     if dotarray is None:</span>
<span class="c1">#         raise ValueError(&quot;dotarray cannot be None&quot;)</span>
<span class="c1">#     assert dotarray.ndim == 2</span>
<span class="c1">#     result = np.full((argshape[0], argshape[1], random_draws.shape[1]), -1, dtype=choice_dtype)</span>
<span class="c1">#     result_p = np.zeros((argshape[0], argshape[1], random_draws.shape[1]), dtype=dtype)</span>
<span class="c1">#     if pick_counted:</span>
<span class="c1">#         pick_count = np.zeros((argshape[0], argshape[1], random_draws.shape[1]), dtype=pick_count_dtype)</span>
<span class="c1">#     else:</span>
<span class="c1">#         pick_count = np.zeros((argshape[0], argshape[1], 0), dtype=pick_count_dtype)</span>
<span class="c1">#     if logsums:</span>
<span class="c1">#         _logsums = np.zeros((argshape[0], argshape[1], ), dtype=dtype)</span>
<span class="c1">#     else:</span>
<span class="c1">#         _logsums = np.zeros((0, 0), dtype=dtype)</span>
<span class="c1">#     for j0 in nb.prange(argshape[0]):</span>
<span class="c1">#         for k0 in range(argshape[1]):</span>
<span class="c1">#             intermediate = np.zeros({len_self_raw_functions}, dtype=dtype)</span>
<span class="c1">#             {meta_code_stack_dot}</span>
<span class="c1">#             dotprod = np.dot(intermediate, dotarray)</span>
<span class="c1">#             shifter = np.max(dotprod)</span>
<span class="c1">#             partial = np.exp(dotprod - shifter)</span>
<span class="c1">#             local_sum = np.sum(partial)</span>
<span class="c1">#             partial /= local_sum</span>
<span class="c1">#             if logsums:</span>
<span class="c1">#                 _logsums[j0,k0] = np.log(local_sum) + shifter</span>
<span class="c1">#             if pick_counted:</span>
<span class="c1">#                 _sample_choices_maker_counted(</span>
<span class="c1">#                   partial, random_draws[j0,k0], result[j0,k0], result_p[j0,k0], pick_count[j0,k0]</span>
<span class="c1">#                 )</span>
<span class="c1">#             else:</span>
<span class="c1">#                 _sample_choices_maker(partial, random_draws[j0,k0], result[j0,k0], result_p[j0,k0])</span>
<span class="c1">#     return result, result_p, pick_count, _logsums</span>


<span class="n">MNL_2D_TEMPLATE</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">MNL_GENERIC_TEMPLATE</span>
    <span class="o">+</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">logit_ndims = 2</span>

<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def mnl_transform(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    dotarray=None,</span>
<span class="s2">    random_draws=None,</span>
<span class="s2">    pick_counted=False,</span>
<span class="s2">    logsums=False,</span>
<span class="s2">    choice_dtype=np.int32,</span>
<span class="s2">    pick_count_dtype=np.int32,</span>
<span class="s2">    mask=None,</span>
<span class="s2">):</span>
<span class="s2">    if dotarray is None:</span>
<span class="s2">        raise ValueError(&quot;dotarray cannot be None&quot;)</span>
<span class="s2">    assert dotarray.ndim == 2</span>
<span class="s2">    assert dotarray.shape[1] == 1</span>
<span class="s2">    dotarray = dotarray.reshape(-1)</span>
<span class="s2">    if random_draws is None:</span>
<span class="s2">        raise ValueError(&quot;random_draws cannot be None&quot;)</span>
<span class="s2">    assert random_draws.ndim == 2</span>
<span class="s2">    assert random_draws.shape[0] == argshape[0]</span>
<span class="s2">    if mask is not None:</span>
<span class="s2">        assert mask.ndim == 1</span>
<span class="s2">        assert mask.shape[0] == argshape[0]</span>

<span class="s2">    result = np.full((argshape[0], random_draws.shape[1]), -1, dtype=choice_dtype)</span>
<span class="s2">    result_p = np.zeros((argshape[0], random_draws.shape[1]), dtype=dtype)</span>
<span class="s2">    if pick_counted:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], random_draws.shape[1]), dtype=pick_count_dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], 0), dtype=pick_count_dtype)</span>
<span class="s2">    if logsums:</span>
<span class="s2">        _logsums = np.zeros((argshape[0], ), dtype=dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        _logsums = np.zeros((0, ), dtype=dtype)</span>
<span class="s2">    for j0 in nb.prange(argshape[0]):</span>
<span class="s2">        if mask is not None:</span>
<span class="s2">            if not mask[j0]:</span>
<span class="s2">                continue</span>
<span class="s2">        partial = np.zeros(argshape[1], dtype=dtype)</span>
<span class="s2">        intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">        shifter = -99999</span>
<span class="s2">        for j1 in range(argshape[1]):</span>
<span class="s2">            intermediate[:] = 0</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            v = partial[j1] = np.dot(intermediate, dotarray)</span>
<span class="s2">            if v &gt; shifter:</span>
<span class="s2">                shifter = v</span>
<span class="s2">        for j1 in range(argshape[1]):</span>
<span class="s2">            partial[j1] = np.exp(partial[j1] - shifter)</span>
<span class="s2">        local_sum = np.sum(partial)</span>
<span class="s2">        if logsums:</span>
<span class="s2">            _logsums[j0] = np.log(local_sum) + shifter</span>
<span class="s2">            if logsums == 1:</span>
<span class="s2">              continue</span>
<span class="s2">        partial /= local_sum</span>
<span class="s2">        if pick_counted:</span>
<span class="s2">            _sample_choices_maker_counted(partial, random_draws[j0], result[j0], result_p[j0], pick_count[j0])</span>
<span class="s2">        else:</span>
<span class="s2">            _sample_choices_maker(partial, random_draws[j0], result[j0], result_p[j0])</span>
<span class="s2">    return result, result_p, pick_count, _logsums</span>


<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def mnl_transform_plus1d(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    dotarray=None,</span>
<span class="s2">    random_draws=None,</span>
<span class="s2">    pick_counted=False,</span>
<span class="s2">    logsums=False,</span>
<span class="s2">    choice_dtype=np.int32,</span>
<span class="s2">    pick_count_dtype=np.int32,</span>
<span class="s2">    mask=None,</span>
<span class="s2">):</span>
<span class="s2">    if dotarray is None:</span>
<span class="s2">        raise ValueError(&quot;dotarray cannot be None&quot;)</span>
<span class="s2">    assert dotarray.ndim == 2</span>
<span class="s2">    assert dotarray.shape[1] &gt;= 1</span>
<span class="s2">    if random_draws is None:</span>
<span class="s2">        raise ValueError(&quot;random_draws cannot be None&quot;)</span>
<span class="s2">    assert random_draws.ndim == 3</span>
<span class="s2">    assert random_draws.shape[0] == argshape[0]</span>
<span class="s2">    assert random_draws.shape[1] == argshape[1]</span>
<span class="s2">    if mask is not None:</span>
<span class="s2">        assert mask.ndim == 2</span>
<span class="s2">        assert mask.shape[0] == argshape[0]</span>
<span class="s2">        assert mask.shape[1] == argshape[1]</span>

<span class="s2">    result = np.full((argshape[0], argshape[1], random_draws.shape[2]), -1, dtype=choice_dtype)</span>
<span class="s2">    result_p = np.zeros((argshape[0], argshape[1], random_draws.shape[2]), dtype=dtype)</span>
<span class="s2">    if pick_counted:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], argshape[1], random_draws.shape[2]), dtype=pick_count_dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], argshape[1], 0), dtype=pick_count_dtype)</span>
<span class="s2">    if logsums:</span>
<span class="s2">        _logsums = np.zeros((argshape[0], argshape[1], ), dtype=dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        _logsums = np.zeros((0, 0), dtype=dtype)</span>
<span class="s2">    for j0 in nb.prange(argshape[0]):</span>
<span class="s2">        partial = np.zeros(dotarray.shape[1], dtype=dtype)</span>
<span class="s2">        for j1 in range(argshape[1]):</span>
<span class="s2">            if mask is not None:</span>
<span class="s2">                if not mask[j0,j1]:</span>
<span class="s2">                    continue</span>
<span class="s2">            intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            partial = np.dot(intermediate, dotarray, out=partial)</span>
<span class="s2">            shifter = np.max(partial)</span>
<span class="s2">            partial = np.exp(partial - shifter)</span>
<span class="s2">            local_sum = np.sum(partial)</span>
<span class="s2">            if logsums:</span>
<span class="s2">                _logsums[j0,j1] = np.log(local_sum) + shifter</span>
<span class="s2">                if logsums == 1:</span>
<span class="s2">                    continue</span>
<span class="s2">            partial /= local_sum</span>
<span class="s2">            if pick_counted:</span>
<span class="s2">                _sample_choices_maker_counted(</span>
<span class="s2">                    partial, random_draws[j0,j1], result[j0,j1], result_p[j0,j1], pick_count[j0,j1]</span>
<span class="s2">                )</span>
<span class="s2">            else:</span>
<span class="s2">                _sample_choices_maker(partial, random_draws[j0,j1], result[j0,j1], result_p[j0,j1])</span>
<span class="s2">    return result, result_p, pick_count, _logsums</span>

<span class="s2">&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="n">NL_1D_TEMPLATE</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>

<span class="s2">from sharrow.nested_logit import _utility_to_probability</span>

<span class="s2">@nb.jit(</span>
<span class="s2">    cache=True,</span>
<span class="s2">    parallel=True,</span>
<span class="s2">    error_model=&#39;</span><span class="si">{error_model}</span><span class="s2">&#39;,</span>
<span class="s2">    boundscheck=</span><span class="si">{boundscheck}</span><span class="s2">,</span>
<span class="s2">    nopython=</span><span class="si">{nopython}</span><span class="s2">,</span>
<span class="s2">    fastmath=</span><span class="si">{fastmath}</span><span class="s2">,</span>
<span class="s2">    nogil=</span><span class="si">{nopython}</span><span class="s2">)</span>
<span class="s2">def nl_transform(</span>
<span class="s2">    argshape,</span>
<span class="s2">    </span><span class="si">{joined_namespace_names}</span>
<span class="s2">    dtype=np.</span><span class="si">{dtype}</span><span class="s2">,</span>
<span class="s2">    dotarray=None,</span>
<span class="s2">    random_draws=None,</span>
<span class="s2">    pick_counted=False,</span>
<span class="s2">    logsums=False,</span>
<span class="s2">    n_nodes=0,</span>
<span class="s2">    n_alts=0,</span>
<span class="s2">    edges_up=None,  # int input shape=[edges]</span>
<span class="s2">    edges_dn=None,  # int input shape=[edges]</span>
<span class="s2">    mu_params=None,  # float input shape=[nests]</span>
<span class="s2">    start_slots=None,  # int input shape=[nests]</span>
<span class="s2">    len_slots=None,  # int input shape=[nests]</span>
<span class="s2">    choice_dtype=np.int32,</span>
<span class="s2">    pick_count_dtype=np.int32,</span>
<span class="s2">    mask=None,</span>
<span class="s2">):</span>
<span class="s2">    if dotarray is None:</span>
<span class="s2">        raise ValueError(&quot;dotarray cannot be None&quot;)</span>
<span class="s2">    assert dotarray.ndim == 2</span>
<span class="s2">    if mask is not None:</span>
<span class="s2">        assert mask.ndim == 1</span>
<span class="s2">        assert mask.shape[0] == argshape[0]</span>
<span class="s2">    if logsums == 1:</span>
<span class="s2">        result = np.full((0, random_draws.shape[1]), -1, dtype=choice_dtype)</span>
<span class="s2">        result_p = np.zeros((0, random_draws.shape[1]), dtype=dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        result = np.full((argshape[0], random_draws.shape[1]), -1, dtype=choice_dtype)</span>
<span class="s2">        result_p = np.zeros((argshape[0], random_draws.shape[1]), dtype=dtype)</span>
<span class="s2">    if pick_counted:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], random_draws.shape[1]), dtype=pick_count_dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        pick_count = np.zeros((argshape[0], 0), dtype=pick_count_dtype)</span>
<span class="s2">    if logsums:</span>
<span class="s2">        _logsums = np.zeros((argshape[0], ), dtype=dtype)</span>
<span class="s2">    else:</span>
<span class="s2">        _logsums = np.zeros((0, ), dtype=dtype)</span>
<span class="s2">    for j0 in nb.prange(argshape[0]):</span>
<span class="s2">            if mask is not None:</span>
<span class="s2">                if not mask[j0]:</span>
<span class="s2">                    continue</span>
<span class="s2">            intermediate = np.zeros(</span><span class="si">{len_self_raw_functions}</span><span class="s2">, dtype=dtype)</span>
<span class="s2">            </span><span class="si">{meta_code_stack_dot}</span>
<span class="s2">            utility = np.zeros(n_nodes, dtype=dtype)</span>
<span class="s2">            utility[:n_alts] = np.dot(intermediate, dotarray)</span>
<span class="s2">            if logsums == 1:</span>
<span class="s2">                logprob = np.zeros(0, dtype=dtype)</span>
<span class="s2">                probability = np.zeros(0, dtype=dtype)</span>
<span class="s2">            else:</span>
<span class="s2">                logprob = np.zeros(n_nodes, dtype=dtype)</span>
<span class="s2">                probability = np.zeros(n_nodes, dtype=dtype)</span>
<span class="s2">            _utility_to_probability(</span>
<span class="s2">                n_alts,</span>
<span class="s2">                edges_up,  # int input shape=[edges]</span>
<span class="s2">                edges_dn,  # int input shape=[edges]</span>
<span class="s2">                mu_params,  # float input shape=[nests]</span>
<span class="s2">                start_slots,  # int input shape=[nests]</span>
<span class="s2">                len_slots,  # int input shape=[nests]</span>
<span class="s2">                (logsums==1),</span>
<span class="s2">                utility,  # float output shape=[nodes]</span>
<span class="s2">                logprob,  # float output shape=[nodes]</span>
<span class="s2">                probability,  # float output shape=[nodes]</span>
<span class="s2">            )</span>
<span class="s2">            if logsums:</span>
<span class="s2">                _logsums[j0] = utility[-1]</span>
<span class="s2">            if logsums != 1:</span>
<span class="s2">                if pick_counted:</span>
<span class="s2">                    _sample_choices_maker_counted(</span>
<span class="s2">                        probability[:n_alts], random_draws[j0], result[j0], result_p[j0], pick_count[j0]</span>
<span class="s2">                    )</span>
<span class="s2">                else:</span>
<span class="s2">                    _sample_choices_maker(probability[:n_alts], random_draws[j0], result[j0], result_p[j0])</span>
<span class="s2">    return result, result_p, pick_count, _logsums</span>

<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">zero_size_to_None</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zero_size_to_None</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to squeeze </span><span class="si">{</span><span class="n">args</span><span class="si">!r}</span><span class="s2"> from array of shape </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to squeeze </span><span class="si">{</span><span class="n">args</span><span class="si">!r}</span><span class="s2"> from array of unknown shape&quot;</span><span class="p">)</span>
        <span class="k">raise</span>


<div class="viewcode-block" id="Flow"><a class="viewcode-back" href="../../api.html#sharrow.Flow">[docs]</a><span class="k">class</span> <span class="nc">Flow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A prepared data flow.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tree : DataTree</span>
<span class="sd">        The tree from whence the output will be constructed.</span>
<span class="sd">    defs : Mapping[str,str]</span>
<span class="sd">        Gives the names and definitions for the variables to create in the</span>
<span class="sd">        generated output.</span>
<span class="sd">    error_model : {&#39;numpy&#39;, &#39;python&#39;}, default &#39;numpy&#39;</span>
<span class="sd">        The error_model option controls the divide-by-zero behavior. Setting</span>
<span class="sd">        it to python causes divide-by-zero to raise exception like</span>
<span class="sd">        CPython. Setting it to numpy causes divide-by-zero to set the</span>
<span class="sd">        result to +/-inf or nan.</span>
<span class="sd">    cache_dir : Path-like, optional</span>
<span class="sd">        A location to write out generated python and numba code. If not</span>
<span class="sd">        provided, a unique temporary directory is created.</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        The name of this Flow used for writing out cached files. If not</span>
<span class="sd">        provided, a unique name is generated. If `cache_dir` is given,</span>
<span class="sd">        be sure to avoid name conflicts with other flow&#39;s in the same</span>
<span class="sd">        directory.</span>
<span class="sd">    dtype : str, default &quot;float32&quot;</span>
<span class="sd">        The name of the numpy dtype that will be used for the output.</span>
<span class="sd">    boundscheck : bool, default False</span>
<span class="sd">        If True, boundscheck enables bounds checking for array indices, and</span>
<span class="sd">        out of bounds accesses will raise IndexError. The default is to not</span>
<span class="sd">        do bounds checking, which is faster but can produce garbage results</span>
<span class="sd">        or segfaults if there are problems, so try turning this on for</span>
<span class="sd">        debugging if you are getting unexplained errors or crashes.</span>
<span class="sd">    nopython : bool, default True</span>
<span class="sd">        Compile using numba&#39;s `nopython` mode.  Provided for debugging only,</span>
<span class="sd">        as there&#39;s little point in turning this off for production code, as</span>
<span class="sd">        all the speed benefits of sharrow will be lost.</span>
<span class="sd">    fastmath : bool, default True</span>
<span class="sd">        If true, fastmath enables the use of &quot;fast&quot; floating point transforms,</span>
<span class="sd">        which can improve performance but can result in tiny distortions in</span>
<span class="sd">        results.  See numba docs for details.</span>
<span class="sd">    parallel : bool, default True</span>
<span class="sd">        Enable or disable parallel computation for certain functions.</span>
<span class="sd">    readme : str, optional</span>
<span class="sd">        A string to inject as a comment at the top of the flow Python file.</span>
<span class="sd">    flow_library : Mapping[str,Flow], optional</span>
<span class="sd">        An in-memory cache of precompiled Flow objects.  Using this can result</span>
<span class="sd">        in performance improvements when repeatedly using the same definitions.</span>
<span class="sd">    extra_hash_data : Tuple[Hashable], optional</span>
<span class="sd">        Additional data used for generating the flow hash.  Useful to prevent</span>
<span class="sd">        conflicts when using a flow_library with multiple similar flows.</span>
<span class="sd">    write_hash_audit : bool, default True</span>
<span class="sd">        Writes a hash audit log into a comment in the flow Python file, for</span>
<span class="sd">        debugging purposes.</span>
<span class="sd">    hashing_level : int, default 1</span>
<span class="sd">        Level of detail to write into flow hashes.  Increase detail to avoid</span>
<span class="sd">        hash conflicts for similar flows.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">,</span>
        <span class="n">defs</span><span class="p">,</span>
        <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
        <span class="n">boundscheck</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">readme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">flow_library</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_hash_data</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">write_hash_audit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">hashing_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dim_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dim_exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bool_wrapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">with_root_node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">DataTree</span><span class="p">)</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">digitize_relationships</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="c1"># clean defs with hidden values</span>
        <span class="n">defs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_flip_flop_def</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="c1"># start init up to flow_hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_1</span><span class="p">(</span>
            <span class="n">tree</span><span class="p">,</span>
            <span class="n">defs</span><span class="p">,</span>
            <span class="n">cache_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span>
            <span class="n">extra_hash_data</span><span class="o">=</span><span class="n">extra_hash_data</span><span class="p">,</span>
            <span class="n">hashing_level</span><span class="o">=</span><span class="n">hashing_level</span><span class="p">,</span>
            <span class="n">dim_order</span><span class="o">=</span><span class="n">dim_order</span><span class="p">,</span>
            <span class="n">dim_exclude</span><span class="o">=</span><span class="n">dim_exclude</span><span class="p">,</span>
            <span class="n">error_model</span><span class="o">=</span><span class="n">error_model</span><span class="p">,</span>
            <span class="n">boundscheck</span><span class="o">=</span><span class="n">boundscheck</span><span class="p">,</span>
            <span class="n">nopython</span><span class="o">=</span><span class="n">nopython</span><span class="p">,</span>
            <span class="n">fastmath</span><span class="o">=</span><span class="n">fastmath</span><span class="p">,</span>
            <span class="n">bool_wrapping</span><span class="o">=</span><span class="n">bool_wrapping</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># return from library if available</span>
        <span class="k">if</span> <span class="n">flow_library</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span> <span class="ow">in</span> <span class="n">flow_library</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flow exists in library: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">flow_library</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="c1"># otherwise finish normal init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_2</span><span class="p">(</span>
            <span class="n">defs</span><span class="p">,</span>
            <span class="n">error_model</span><span class="o">=</span><span class="n">error_model</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">boundscheck</span><span class="o">=</span><span class="n">boundscheck</span><span class="p">,</span>
            <span class="n">nopython</span><span class="o">=</span><span class="n">nopython</span><span class="p">,</span>
            <span class="n">fastmath</span><span class="o">=</span><span class="n">fastmath</span><span class="p">,</span>
            <span class="n">readme</span><span class="o">=</span><span class="n">readme</span><span class="p">,</span>
            <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
            <span class="n">extra_hash_data</span><span class="o">=</span><span class="n">extra_hash_data</span><span class="p">,</span>
            <span class="n">write_hash_audit</span><span class="o">=</span><span class="n">write_hash_audit</span><span class="p">,</span>
            <span class="n">with_root_node_name</span><span class="o">=</span><span class="n">with_root_node_name</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">flow_library</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">flow_library</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_root_node_name</span> <span class="o">=</span> <span class="n">with_root_node_name</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__initialize_1</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">,</span>
        <span class="n">defs</span><span class="p">,</span>
        <span class="n">cache_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_hash_data</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">,</span>
        <span class="n">boundscheck</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">hashing_level</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">dim_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dim_exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bool_wrapping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize up to the flow_hash</span>

<span class="sd">        See main docstring for arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cache_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tempfile</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">temp_cache_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_cache_dir</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">cache_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_secondary_flows</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span> <span class="o">=</span> <span class="n">dim_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span> <span class="o">=</span> <span class="n">dim_exclude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span> <span class="o">=</span> <span class="n">bool_wrapping</span>

        <span class="n">all_raw_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">all_name_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_k</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">plain_names</span><span class="p">,</span> <span class="n">attribute_pairs</span><span class="p">,</span> <span class="n">subscript_pairs</span> <span class="o">=</span> <span class="n">extract_names_2</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">all_raw_names</span> <span class="o">|=</span> <span class="n">plain_names</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">:</span>
                <span class="n">all_raw_names</span> <span class="o">|=</span> <span class="n">attribute_pairs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                <span class="n">all_raw_names</span> <span class="o">|=</span> <span class="n">subscript_pairs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root_node_name</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

        <span class="n">dimensions_ordered</span> <span class="o">=</span> <span class="n">presorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">)</span>
        <span class="n">index_slots</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dimensions_ordered</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_name_positions</span> <span class="o">=</span> <span class="n">index_slots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_names</span> <span class="o">=</span> <span class="n">dimensions_ordered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_name_positions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_vars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_raw_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_vars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_funcs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_funcs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_funcs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">all_raw_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_funcs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_used_aux_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">aux_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">aux_vars</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">aux_var</span> <span class="ow">in</span> <span class="n">all_raw_names</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_used_aux_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aux_var</span><span class="p">)</span>

        <span class="n">subspace_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces_iter</span><span class="p">():</span>
            <span class="n">subspace_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspace_fallbacks</span><span class="p">:</span>
            <span class="n">subspace_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">optional_get_tokens</span> <span class="o">=</span> <span class="n">ExtractOptionalGetTokens</span><span class="p">(</span><span class="n">from_names</span><span class="o">=</span><span class="n">subspace_names</span><span class="p">)</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
            <span class="n">defs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optional_get_tokens</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">optional_get_tokens</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">_spacename</span><span class="p">,</span> <span class="n">_varname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">optional_get_tokens</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">_spacename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span>
                    <span class="ow">and</span> <span class="n">_varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">_spacename</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_optional_get_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">_spacename</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">_varname</span><span class="si">}</span><span class="s2">:True&quot;</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">_spacename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspace_fallbacks</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_subspacename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspace_fallbacks</span><span class="p">[</span><span class="n">_spacename</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">_varname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">_subspacename</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_optional_get_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">_subspacename</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">_varname</span><span class="si">}</span><span class="s2">:__</span><span class="si">{</span><span class="n">_spacename</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">_varname</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_optional_get_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">_spacename</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">_varname</span><span class="si">}</span><span class="s2">:False&quot;</span>
                    <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hashing_level</span> <span class="o">=</span> <span class="n">hashing_level</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hashing_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">func_code</span><span class="p">,</span> <span class="n">all_name_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_sub_funcs</span><span class="p">(</span>
                <span class="n">defs</span><span class="p">,</span>
                <span class="n">error_model</span><span class="o">=</span><span class="n">error_model</span><span class="p">,</span>
                <span class="n">boundscheck</span><span class="o">=</span><span class="n">boundscheck</span><span class="p">,</span>
                <span class="n">nopython</span><span class="o">=</span><span class="n">nopython</span><span class="p">,</span>
                <span class="n">fastmath</span><span class="o">=</span><span class="n">fastmath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func_code</span> <span class="o">=</span> <span class="n">func_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_name_tokens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func_code</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_dictionaries</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># compute the complete hash including defs, used_extra_vars, and namespace_names</span>
        <span class="c1"># digest size 20 creates a base32 encoded 32 character flow_hash string</span>
        <span class="n">flow_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">blake2b</span><span class="p">(</span><span class="n">digest_size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">flow_hash_audit</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">_flow_hash_push</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">flow_hash</span><span class="p">,</span> <span class="n">flow_hash_audit</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">flow_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">))</span>
            <span class="n">flow_hash_audit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#    &quot;</span><span class="p">))</span>

        <span class="n">_flow_hash_push</span><span class="p">(</span><span class="s2">&quot;---DataTree Flow---&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_vars</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_vars</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_used_aux_vars</span><span class="p">):</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;aux_var:</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_funcs</span><span class="p">):</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;func:</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_optional_get_tokens</span><span class="p">):</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OPTIONAL:</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_flow_hash_push</span><span class="p">(</span><span class="s2">&quot;---DataTree---&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_names</span><span class="p">:</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;arg:</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">_hash_features</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hashing_level</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># or not k.startswith(&quot;relationship:&quot;):</span>
                <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">:</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="s2">&quot;---dim-order---&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">:</span>
                <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sname</span><span class="p">,</span> <span class="n">sdata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces_iter</span><span class="p">():</span>
            <span class="n">digital_encoding_hashes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">iname</span><span class="p">,</span> <span class="n">idata</span> <span class="ow">in</span> <span class="n">sdata</span><span class="o">.</span><span class="n">digital_encoding</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">digital_encoding_hashes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;digital_encoding:</span><span class="si">{</span><span class="n">sname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">iname</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">idata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># ensure these are hashed in a stable ordering</span>
            <span class="k">for</span> <span class="n">ihash</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">digital_encoding_hashes</span><span class="p">):</span>
                <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">ihash</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hashing_level</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__base__&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">digital_encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span>
                            <span class="s2">&quot;__&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;digital_encoding&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="k">pass</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$$$$/ndigital_encoding=ERR</span><span class="se">\n</span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="se">\n\n\n</span><span class="s2">$$$&quot;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;$$$$/n</span><span class="si">{</span><span class="n">digital_encoding</span><span class="si">=}</span><span class="se">\n\n\n</span><span class="s2">$$$&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">digital_encoding</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">de_k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">digital_encoding</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">de_v</span> <span class="o">=</span> <span class="n">digital_encoding</span><span class="p">[</span><span class="n">de_k</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">de_k</span> <span class="o">==</span> <span class="s2">&quot;dictionary&quot;</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">encoding_dictionaries</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">de_v</span>
                                <span class="n">_flow_hash_push</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;digital_encoding&quot;</span><span class="p">,</span> <span class="n">de_k</span><span class="p">,</span> <span class="n">de_v</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">extra_hash_data</span><span class="p">:</span>
            <span class="n">_flow_hash_push</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;boundscheck=</span><span class="si">{</span><span class="n">boundscheck</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;error_model=</span><span class="si">{</span><span class="n">error_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fastmath=</span><span class="si">{</span><span class="n">fastmath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">_flow_hash_push</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bool_wrapping=</span><span class="si">{</span><span class="n">bool_wrapping</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b32encode</span><span class="p">(</span><span class="n">flow_hash</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flow_hash_audit</span> <span class="o">=</span> <span class="s2">&quot;]</span><span class="se">\n</span><span class="s2"># [&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flow_hash_audit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_index_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="n">n</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">presorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">init_sub_funcs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">defs</span><span class="p">,</span>
        <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">,</span>
        <span class="n">boundscheck</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">func_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">all_name_tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">index_slots</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">i</span><span class="p">:</span> <span class="n">n</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">presorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_name_positions</span> <span class="o">=</span> <span class="n">index_slots</span>
        <span class="n">candidate_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">namespace_names</span><span class="p">()</span>
        <span class="n">candidate_names</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__aux_var__</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">aux_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">meta_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">relationships_are_digitized</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spacename</span><span class="p">,</span> <span class="n">spacearrays</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dim_slots</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">spacekeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spacearrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">spacearrays</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">spacekeys</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">spacearrays_vars</span> <span class="o">=</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">_variables</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="n">spacearrays_vars</span> <span class="o">=</span> <span class="n">spacearrays</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">toks</span><span class="p">,</span> <span class="n">blends</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">_arg_tokenizer</span><span class="p">(</span>
                            <span class="n">spacename</span><span class="p">,</span>
                            <span class="n">spacearray</span><span class="o">=</span><span class="n">spacearrays_vars</span><span class="p">[</span><span class="n">k1</span><span class="p">],</span>
                            <span class="n">spacearrayname</span><span class="o">=</span><span class="n">k1</span><span class="p">,</span>
                            <span class="n">exclude_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dim_slots</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">toks</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">digital_encodings</span> <span class="o">=</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">digital_encoding</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">digital_encodings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">blenders</span> <span class="o">=</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">redirection</span><span class="o">.</span><span class="n">blenders</span>
                <span class="n">meta_data</span><span class="p">[</span><span class="n">spacename</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim_slots</span><span class="p">,</span> <span class="n">digital_encodings</span><span class="p">,</span> <span class="n">blenders</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spacename</span><span class="p">,</span> <span class="n">spacearrays</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">dim_slots</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">spacekeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spacearrays</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">spacearrays</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">spacekeys</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_dims</span> <span class="o">=</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">_variables</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="n">_dims</span> <span class="o">=</span> <span class="n">spacearrays</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span>
                    <span class="n">dim_slots</span><span class="p">[</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_slots</span><span class="p">[</span><span class="n">z</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">_dims</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">digital_encodings</span> <span class="o">=</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">digital_encoding</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">digital_encodings</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">blenders</span> <span class="o">=</span> <span class="n">spacearrays</span><span class="o">.</span><span class="n">redirection</span><span class="o">.</span><span class="n">blenders</span>
                <span class="n">meta_data</span><span class="p">[</span><span class="n">spacename</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim_slots</span><span class="p">,</span> <span class="n">digital_encodings</span><span class="p">,</span> <span class="n">blenders</span><span class="p">)</span>

        <span class="c1"># write individual function files for each expression</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">defs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="n">prior_expr</span> <span class="o">=</span> <span class="n">init_expr</span> <span class="o">=</span> <span class="n">expr</span>
            <span class="n">other_way</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">other_way</span><span class="p">:</span>
                <span class="n">other_way</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># if other_way is triggered, there may be residual other terms</span>
                <span class="c1"># that were not addressed, so this loop should be applied again.</span>
                <span class="k">for</span> <span class="n">spacename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">dim_slots</span><span class="p">,</span> <span class="n">digital_encodings</span><span class="p">,</span> <span class="n">blenders</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span><span class="n">spacename</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                            <span class="n">expr</span><span class="p">,</span>
                            <span class="n">spacename</span><span class="p">,</span>
                            <span class="n">dim_slots</span><span class="p">,</span>
                            <span class="n">dim_slots</span><span class="p">,</span>
                            <span class="n">digital_encodings</span><span class="o">=</span><span class="n">digital_encodings</span><span class="p">,</span>
                            <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                            <span class="n">blenders</span><span class="o">=</span><span class="n">blenders</span><span class="p">,</span>
                            <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">key_err</span><span class="p">:</span>
                        <span class="c1"># there was an error, but lets make sure we process the</span>
                        <span class="c1"># whole expression to rewrite all the things we can before</span>
                        <span class="c1"># moving on to the fallback processing.</span>
                        <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                            <span class="n">expr</span><span class="p">,</span>
                            <span class="n">spacename</span><span class="p">,</span>
                            <span class="n">dim_slots</span><span class="p">,</span>
                            <span class="n">dim_slots</span><span class="p">,</span>
                            <span class="n">digital_encodings</span><span class="o">=</span><span class="n">digital_encodings</span><span class="p">,</span>
                            <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                            <span class="n">blenders</span><span class="o">=</span><span class="n">blenders</span><span class="p">,</span>
                            <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
                            <span class="n">swallow_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="c1"># Now for the fallback processing...</span>
                        <span class="k">if</span> <span class="s2">&quot;..&quot;</span> <span class="ow">in</span> <span class="n">key_err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">topkey</span><span class="p">,</span> <span class="n">attrkey</span> <span class="o">=</span> <span class="n">key_err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span>
                        <span class="c1"># check if we can resolve this name on any other subspace</span>
                        <span class="k">for</span> <span class="n">other_spacename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspace_fallbacks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">topkey</span><span class="p">,</span> <span class="p">[]</span>
                        <span class="p">):</span>
                            <span class="n">dim_slots</span><span class="p">,</span> <span class="n">digital_encodings</span><span class="p">,</span> <span class="n">blenders</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span>
                                <span class="n">other_spacename</span>
                            <span class="p">]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                                    <span class="n">expr</span><span class="p">,</span>
                                    <span class="n">spacename</span><span class="p">,</span>
                                    <span class="n">dim_slots</span><span class="p">,</span>
                                    <span class="n">dim_slots</span><span class="p">,</span>
                                    <span class="n">digital_encodings</span><span class="o">=</span><span class="n">digital_encodings</span><span class="p">,</span>
                                    <span class="n">prefer_name</span><span class="o">=</span><span class="n">other_spacename</span><span class="p">,</span>
                                    <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                                    <span class="n">blenders</span><span class="o">=</span><span class="n">blenders</span><span class="p">,</span>
                                    <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># noqa: F841</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">other_way</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># at least one variable was found in a fallback</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">other_way</span> <span class="ow">and</span> <span class="s2">&quot;get&quot;</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
                            <span class="c1"># any remaining &quot;get&quot; expressions with defaults should now use them</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                                    <span class="n">expr</span><span class="p">,</span>
                                    <span class="n">spacename</span><span class="p">,</span>
                                    <span class="n">dim_slots</span><span class="p">,</span>
                                    <span class="n">dim_slots</span><span class="p">,</span>
                                    <span class="n">digital_encodings</span><span class="o">=</span><span class="n">digital_encodings</span><span class="p">,</span>
                                    <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                                    <span class="n">blenders</span><span class="o">=</span><span class="n">blenders</span><span class="p">,</span>
                                    <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
                                    <span class="n">get_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># noqa: F841</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">other_way</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="c1"># at least one variable was found in a get</span>
                                <span class="k">break</span>
                            <span class="c1"># check if we can resolve this &quot;get&quot; on any other subspace</span>
                            <span class="k">for</span> <span class="n">other_spacename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspace_fallbacks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                <span class="n">topkey</span><span class="p">,</span> <span class="p">[]</span>
                            <span class="p">):</span>
                                <span class="n">dim_slots</span><span class="p">,</span> <span class="n">digital_encodings</span><span class="p">,</span> <span class="n">blenders</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span>
                                    <span class="n">other_spacename</span>
                                <span class="p">]</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                                        <span class="n">expr</span><span class="p">,</span>
                                        <span class="n">spacename</span><span class="p">,</span>
                                        <span class="n">dim_slots</span><span class="p">,</span>
                                        <span class="n">dim_slots</span><span class="p">,</span>
                                        <span class="n">digital_encodings</span><span class="o">=</span><span class="n">digital_encodings</span><span class="p">,</span>
                                        <span class="n">prefer_name</span><span class="o">=</span><span class="n">other_spacename</span><span class="p">,</span>
                                        <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                                        <span class="n">blenders</span><span class="o">=</span><span class="n">blenders</span><span class="p">,</span>
                                        <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
                                        <span class="n">get_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>  <span class="c1"># noqa: F841</span>
                                    <span class="k">pass</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">other_way</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="c1"># at least one variable was found in a fallback</span>
                                    <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">other_way</span><span class="p">:</span>
                            <span class="k">raise</span>
                <span class="k">if</span> <span class="n">prior_expr</span> <span class="o">==</span> <span class="n">expr</span><span class="p">:</span>
                    <span class="c1"># nothing was changed, break out of loop</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># something was changed, run the loop again to confirm</span>
                    <span class="c1"># nothing else needs to change</span>
                    <span class="n">prior_expr</span> <span class="o">=</span> <span class="n">expr</span>

            <span class="c1"># now process for subspace fallbacks</span>
            <span class="k">for</span> <span class="n">gd</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>
                <span class="c1"># first run all these with get_default off, nothing drops to defaults</span>
                <span class="c1"># if we might find it later.  Then do a second pass with get_default on.</span>
                <span class="k">for</span> <span class="p">(</span>
                    <span class="n">alias_spacename</span><span class="p">,</span>
                    <span class="n">actual_spacenames</span><span class="p">,</span>
                <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspace_fallbacks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">actual_spacename</span> <span class="ow">in</span> <span class="n">actual_spacenames</span><span class="p">:</span>
                        <span class="n">dim_slots</span><span class="p">,</span> <span class="n">digital_encodings</span><span class="p">,</span> <span class="n">blenders</span> <span class="o">=</span> <span class="n">meta_data</span><span class="p">[</span>
                            <span class="n">actual_spacename</span>
                        <span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                                <span class="n">expr</span><span class="p">,</span>
                                <span class="n">alias_spacename</span><span class="p">,</span>
                                <span class="n">dim_slots</span><span class="p">,</span>
                                <span class="n">dim_slots</span><span class="p">,</span>
                                <span class="n">digital_encodings</span><span class="o">=</span><span class="n">digital_encodings</span><span class="p">,</span>
                                <span class="n">prefer_name</span><span class="o">=</span><span class="n">actual_spacename</span><span class="p">,</span>
                                <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                                <span class="n">blenders</span><span class="o">=</span><span class="n">blenders</span><span class="p">,</span>
                                <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
                                <span class="n">get_default</span><span class="o">=</span><span class="n">gd</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="c1"># there was an error, but lets make sure we process the</span>
                            <span class="c1"># whole expression to rewrite all the things we can before</span>
                            <span class="c1"># moving on to the fallback processing.</span>
                            <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                                <span class="n">expr</span><span class="p">,</span>
                                <span class="n">alias_spacename</span><span class="p">,</span>
                                <span class="n">dim_slots</span><span class="p">,</span>
                                <span class="n">dim_slots</span><span class="p">,</span>
                                <span class="n">digital_encodings</span><span class="o">=</span><span class="n">digital_encodings</span><span class="p">,</span>
                                <span class="n">prefer_name</span><span class="o">=</span><span class="n">actual_spacename</span><span class="p">,</span>
                                <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                                <span class="n">blenders</span><span class="o">=</span><span class="n">blenders</span><span class="p">,</span>
                                <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
                                <span class="n">swallow_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">get_default</span><span class="o">=</span><span class="n">gd</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="c1"># now find instances where an identifier is previously created in this flow.</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                <span class="n">expr</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_name_positions</span><span class="p">,</span>
                <span class="s2">&quot;_outputs&quot;</span><span class="p">,</span>
                <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">aux_tokens</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;__aux_var__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">body</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">aux_vars</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="c1"># now handle aux vars</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="n">expression_for_numba</span><span class="p">(</span>
                <span class="n">expr</span><span class="p">,</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">(),</span>
                <span class="n">spacevars</span><span class="o">=</span><span class="n">aux_tokens</span><span class="p">,</span>
                <span class="n">prefer_name</span><span class="o">=</span><span class="s2">&quot;aux_var&quot;</span><span class="p">,</span>
                <span class="n">extra_vars</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_vars</span><span class="p">,</span>
                <span class="n">bool_wrapping</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bool_wrapping</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">init_expr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">init_expr</span> <span class="o">==</span> <span class="n">expr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unable to rewrite &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; to itself&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unable to rewrite &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; to itself&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">] rewrite </span><span class="si">{</span><span class="n">init_expr</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate_names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;there are no candidate namespace names loaded&quot;</span><span class="p">)</span>
            <span class="n">f_name_tokens</span><span class="p">,</span> <span class="n">f_arg_tokens</span> <span class="o">=</span> <span class="n">filter_name_tokens</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">candidate_names</span><span class="p">)</span>
            <span class="n">all_name_tokens</span> <span class="o">|=</span> <span class="n">f_name_tokens</span>
            <span class="n">argtokens</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">f_arg_tokens</span><span class="p">)</span>
            <span class="n">argtokens_</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argtokens</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">argtokens_</span><span class="p">:</span>
                <span class="n">argtokens_</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span>
            <span class="n">func_code</span> <span class="o">+=</span> <span class="n">FUNCTION_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                <span class="n">fname</span><span class="o">=</span><span class="n">clean</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                <span class="n">argtokens</span><span class="o">=</span><span class="n">argtokens_</span><span class="p">,</span>
                <span class="n">nametokens</span><span class="o">=</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">f_name_tokens</span><span class="p">)),</span>
                <span class="n">error_model</span><span class="o">=</span><span class="n">error_model</span><span class="p">,</span>
                <span class="n">extra_imports</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;from .extra_funcs import *&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_funcs</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;from .extra_vars import *&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_vars</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">),</span>
                <span class="n">boundscheck</span><span class="o">=</span><span class="n">boundscheck</span><span class="p">,</span>
                <span class="n">nopython</span><span class="o">=</span><span class="n">nopython</span><span class="p">,</span>
                <span class="n">fastmath</span><span class="o">=</span><span class="n">fastmath</span><span class="p">,</span>
                <span class="n">init_expr</span><span class="o">=</span><span class="n">init_expr</span> <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">init_expr</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">init_expr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">init_expr</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">f_name_tokens</span><span class="p">,</span> <span class="n">argtokens</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_name_positions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

        <span class="k">return</span> <span class="n">func_code</span><span class="p">,</span> <span class="n">all_name_tokens</span>

    <span class="k">def</span> <span class="nf">__initialize_2</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">defs</span><span class="p">,</span>
        <span class="n">error_model</span><span class="o">=</span><span class="s2">&quot;numpy&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
        <span class="n">boundscheck</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">readme</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extra_hash_data</span><span class="o">=</span><span class="p">(),</span>
        <span class="n">write_hash_audit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">with_root_node_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tree : DataTree</span>
<span class="sd">        defs : Dict[str,str]</span>
<span class="sd">            Gives the names and definitions for the columns to create in our</span>
<span class="sd">            generated table.</span>
<span class="sd">        error_model : {&#39;numpy&#39;, &#39;python&#39;}, default &#39;numpy&#39;</span>
<span class="sd">            The error_model option controls the divide-by-zero behavior. Setting</span>
<span class="sd">            it to python causes divide-by-zero to raise exception like</span>
<span class="sd">            CPython. Setting it to numpy causes divide-by-zero to set the</span>
<span class="sd">            result to +/-inf or nan.</span>
<span class="sd">        cache_dir : Path-like, optional</span>
<span class="sd">            A location to write out generated python and numba code. If not</span>
<span class="sd">            provided, a unique temporary directory is created.</span>
<span class="sd">        name : str, optional</span>
<span class="sd">            The name of this Flow used for writing out cached files. If not</span>
<span class="sd">            provided, a unique name is generated. If `cache_dir` is given,</span>
<span class="sd">            be sure to avoid name conflicts with other flow&#39;s in the same</span>
<span class="sd">            directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hashing_level</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">func_code</span><span class="p">,</span> <span class="n">all_name_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_sub_funcs</span><span class="p">(</span>
                <span class="n">defs</span><span class="p">,</span>
                <span class="n">error_model</span><span class="o">=</span><span class="n">error_model</span><span class="p">,</span>
                <span class="n">boundscheck</span><span class="o">=</span><span class="n">boundscheck</span><span class="p">,</span>
                <span class="n">nopython</span><span class="o">=</span><span class="n">nopython</span><span class="p">,</span>
                <span class="n">fastmath</span><span class="o">=</span><span class="n">fastmath</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func_code</span> <span class="o">=</span> <span class="n">func_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_name_tokens</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__base__&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">digital_encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">subspaces</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span>
                            <span class="s2">&quot;__&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;digital_encoding&quot;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">digital_encoding</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">de_k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">digital_encoding</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                                <span class="n">de_v</span> <span class="o">=</span> <span class="n">digital_encoding</span><span class="p">[</span><span class="n">de_k</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">de_k</span> <span class="o">==</span> <span class="s2">&quot;dictionary&quot;</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">encoding_dictionaries</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">de_v</span>

        <span class="c1"># assign flow name based on hash unless otherwise given</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;flow_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1"># create the package directory for the flow if it does not exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># if an existing __init__ file matches the hash, just use it</span>
        <span class="n">init_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">init_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">init_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;flow_hash = [&#39;&quot;](.*)[&#39;&quot;]&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;using existing flow code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">writing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;writing fresh flow code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">writing</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">writing</span><span class="p">:</span>
            <span class="n">dependencies</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;import numpy as np&quot;</span><span class="p">,</span>
                <span class="s2">&quot;import numba as nb&quot;</span><span class="p">,</span>
                <span class="s2">&quot;import pandas as pd&quot;</span><span class="p">,</span>
                <span class="s2">&quot;import pyarrow as pa&quot;</span><span class="p">,</span>
                <span class="s2">&quot;import xarray as xr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;import sharrow as sh&quot;</span><span class="p">,</span>
                <span class="s2">&quot;import inspect&quot;</span><span class="p">,</span>
                <span class="s2">&quot;import warnings&quot;</span><span class="p">,</span>
                <span class="s2">&quot;from contextlib import suppress&quot;</span><span class="p">,</span>
                <span class="s2">&quot;from numpy import log, exp, log1p, expm1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;from sharrow.maths import piece, hard_sigmoid, transpose_leading, clip, digital_decode&quot;</span><span class="p">,</span>
                <span class="s2">&quot;from sharrow.sparse import get_blended_2, isnan_fast_safe&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">func_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_code</span>

            <span class="c1"># write extra_funcs file, if there are any extra_funcs</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_funcs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">cloudpickle</span> <span class="k">as</span> <span class="nn">pickle</span>
                <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pickle</span>
                <span class="n">func_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># extra_funcs</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">x_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">extra_funcs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x_func</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_funcs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">x_func</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
                            <span class="n">dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;import pickle&quot;</span><span class="p">)</span>
                            <span class="n">func_code</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">x_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> = pickle.loads(</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">x_func</span><span class="p">))</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">func_code</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">from </span><span class="si">{</span><span class="n">x_func</span><span class="o">.</span><span class="vm">__module__</span><span class="si">}</span><span class="s2"> import </span><span class="si">{</span><span class="n">x_func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="c1"># write extra_vars file, if there are any used extra_vars</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_vars</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">cloudpickle</span> <span class="k">as</span> <span class="nn">pickle</span>
                <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pickle</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                <span class="c1"># any_pickle = False</span>
                <span class="k">for</span> <span class="n">x_name</span><span class="p">,</span> <span class="n">x_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_used_extra_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_var</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                        <span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">x_var</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x_name</span><span class="si">}</span><span class="s2"> = pickle.loads(</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">x_var</span><span class="p">))</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;import pickle&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">x_code</span><span class="p">:</span>
                    <span class="n">x_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">x_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                    <span class="n">func_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># extra_vars</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">func_code</span> <span class="o">+=</span> <span class="n">x_code</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

            <span class="c1"># write encoding dictionaries, if there are any used</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding_dictionaries</span><span class="p">):</span>
                <span class="n">dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;import pickle&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">cloudpickle</span> <span class="k">as</span> <span class="nn">pickle</span>
                <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">pickle</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">x_name</span><span class="p">,</span> <span class="n">x_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding_dictionaries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;__encoding_dict</span><span class="si">{</span><span class="n">x_name</span><span class="si">}</span><span class="s2"> = pickle.loads(</span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">x_dict</span><span class="p">))</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">with</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span> <span class="k">as</span> <span class="n">x_code</span><span class="p">:</span>
                    <span class="n">x_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">x_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
                    <span class="n">func_code</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># encoding dictionaries</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">func_code</span> <span class="o">+=</span> <span class="n">x_code</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

            <span class="c1"># write the master module for this flow</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">rewrite</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">),</span> <span class="s2">&quot;wt&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">f_code</span><span class="p">:</span>

                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                # this module generated automatically using sharrow version </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span>
<span class="s2">                # generation time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %B %Y %I:%M:%S %p&#39;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">                &quot;&quot;&quot;</span>
                    <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">readme</span><span class="p">:</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span>
                            <span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">readme</span><span class="p">),</span>
                            <span class="s2">&quot;# &quot;</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">dependencies_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">depend</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">depend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;import &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">depend</span><span class="p">:</span>
                        <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">depend</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">dependencies_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span>
                <span class="n">dependencies</span> <span class="o">-=</span> <span class="n">dependencies_</span>
                <span class="k">for</span> <span class="n">depend</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">depend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;import &quot;</span><span class="p">):</span>
                        <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">depend</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">dependencies_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span>
                <span class="n">dependencies</span> <span class="o">-=</span> <span class="n">dependencies_</span>
                <span class="k">for</span> <span class="n">depend</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">depend</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;from &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;from .&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">depend</span><span class="p">:</span>
                        <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">depend</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">dependencies_</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span>
                <span class="n">dependencies</span> <span class="o">-=</span> <span class="n">dependencies_</span>
                <span class="k">for</span> <span class="n">depend</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">depend</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># namespace names</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span><span class="p">):</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# - </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">extra_hash_data</span><span class="p">:</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># extra_hash_data</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">extra_hash_data</span><span class="p">:</span>
                        <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># function code</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">blacken</span><span class="p">(</span><span class="n">func_code</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># machinery code</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">relationships_are_digitized</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">with_root_node_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">with_root_node_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">root_node_name</span>

                    <span class="n">root_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">presorted</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">with_root_node_name</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">n_root_dims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">root_dims</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">n_root_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">js</span> <span class="o">=</span> <span class="s2">&quot;j0&quot;</span>
                    <span class="k">elif</span> <span class="n">n_root_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">js</span> <span class="o">=</span> <span class="s2">&quot;j0, j1&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;n_root_dims only supported up to 2, not </span><span class="si">{</span><span class="n">n_root_dims</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                    <span class="n">meta_code</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">meta_code_dot</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">):</span>
                        <span class="n">f_name_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">f_arg_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">f_name_tokens</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">f_name_tokens</span><span class="p">))</span>
                        <span class="n">f_args_j</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;j</span><span class="si">{</span><span class="n">argn</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">argn</span> <span class="ow">in</span> <span class="n">f_arg_tokens</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">f_args_j</span><span class="p">:</span>
                            <span class="n">f_args_j</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span>
                        <span class="n">meta_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;result[</span><span class="si">{</span><span class="n">js</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">] = (</span><span class="si">{</span><span class="n">clean</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">f_args_j</span><span class="si">}</span><span class="s2">result[</span><span class="si">{</span><span class="n">js</span><span class="si">}</span><span class="s2">], </span><span class="si">{</span><span class="n">f_name_tokens</span><span class="si">}</span><span class="s2">)).item()&quot;</span>
                        <span class="p">)</span>
                        <span class="n">meta_code_dot</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;intermediate[</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">] = (</span><span class="si">{</span><span class="n">clean</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">f_args_j</span><span class="si">}</span><span class="s2">intermediate, </span><span class="si">{</span><span class="n">f_name_tokens</span><span class="si">}</span><span class="s2">)).item()&quot;</span>
                        <span class="p">)</span>
                    <span class="n">meta_code_stack</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_code</span><span class="p">),</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">12</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                    <span class="n">meta_code_stack_dot</span> <span class="o">=</span> <span class="n">textwrap</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_code_dot</span><span class="p">),</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="mi">12</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                    <span class="n">len_self_raw_functions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">)</span>
                    <span class="n">joined_namespace_names</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nn</span><span class="si">}</span><span class="s2">,&quot;</span> <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span>
                    <span class="p">)</span>
                    <span class="n">linefeed</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">                           &quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">meta_code_stack_dot</span><span class="p">:</span>
                        <span class="n">meta_code_stack_dot</span> <span class="o">=</span> <span class="s2">&quot;pass&quot;</span>
                    <span class="k">if</span> <span class="n">n_root_dims</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">meta_template</span> <span class="o">=</span> <span class="n">IRUNNER_1D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">meta_template_dot</span> <span class="o">=</span> <span class="n">IDOTTER_1D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
                        <span class="n">line_template</span> <span class="o">=</span> <span class="n">ILINER_1D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">mnl_template</span> <span class="o">=</span> <span class="n">MNL_1D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">nl_template</span> <span class="o">=</span> <span class="n">NL_1D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">n_root_dims</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">meta_template</span> <span class="o">=</span> <span class="n">IRUNNER_2D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">meta_template_dot</span> <span class="o">=</span> <span class="n">IDOTTER_2D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span>
                        <span class="n">line_template</span> <span class="o">=</span> <span class="n">ILINER_2D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">mnl_template</span> <span class="o">=</span> <span class="n">MNL_2D_TEMPLATE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="nb">locals</span><span class="p">())</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="o">**</span><span class="nb">locals</span><span class="p">()</span>
                        <span class="p">)</span>
                        <span class="n">nl_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid n_root_dims </span><span class="si">{</span><span class="n">n_root_dims</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;digitization is now required&quot;</span><span class="p">)</span>

                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blacken</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">line_template</span><span class="p">)))</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blacken</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">mnl_template</span><span class="p">)))</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blacken</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">nl_template</span><span class="p">)))</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blacken</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">meta_template</span><span class="p">)))</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blacken</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="n">meta_template_dot</span><span class="p">)))</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">blacken</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_namespace_names</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">write_hash_audit</span><span class="p">:</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"># hash audit</span><span class="se">\n</span><span class="s2"># [&quot;</span><span class="p">)</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash_audit</span><span class="p">)</span>
                    <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;# Greetings, tinkerer!  The `flow_hash` included here is a safety </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;# measure to prevent unknowing users creating a mess by modifying </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;# the code in this module so that it no longer matches the expected </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;# variable definitions. If you want to modify this code, you should </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;# delete this hash to allow the code to run without any checks, but </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;# you do so at your own risk. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">f_code</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;flow_hash = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="si">!r}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">abs_cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">abs_cache_dir</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;inserting </span><span class="si">{</span><span class="n">abs_cache_dir</span><span class="si">}</span><span class="s2"> into sys.path&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">abs_cache_dir</span><span class="p">))</span>
            <span class="n">added_cache_dir_to_sys_path</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">added_cache_dir_to_sys_path</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;importing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
            <span class="c1"># maybe we got out in front of the file system, wait a beat and retry</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- os.getcwd: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- sys.path: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="k">if</span> <span class="n">added_cache_dir_to_sys_path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;runner&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dotter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;dotter&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_irunner</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;irunner&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;logit_ndims&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imnl</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;mnl_transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imnl_plus1d</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;mnl_transform_plus1d&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inestedlogit</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;nl_transform&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idotter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;idotter&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_linemaker</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;linemaker&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">writing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_names</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">function_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_name_positions</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">output_name_positions</span>

    <span class="k">def</span> <span class="nf">load_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="n">DataTree</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">NumbaExperimentalFeatureWarning</span>
            <span class="p">)</span>
            <span class="n">assembled_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_name_positions</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">assembled_args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aa</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;position arguments are not all integers&quot;</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
                    <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">runner_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runner</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">runner_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dotter</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">runner_</span> <span class="o">=</span> <span class="n">runner</span>
                <span class="n">named_args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">runner_</span><span class="o">.</span><span class="n">py_func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
                <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">named_args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="s2">&quot;dotarray&quot;</span><span class="p">,</span> <span class="s2">&quot;inputarray&quot;</span><span class="p">,</span> <span class="s2">&quot;argarray&quot;</span><span class="p">}:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_arg&quot;</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="n">arg_value</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">get_named_array</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="c1"># aux_vars get passed through as is, not forced to be arrays</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__aux_var&quot;</span><span class="p">):</span>
                        <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">arg_value_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arg_value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">arg_value_array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
                            <span class="c1"># convert object arrays to unicode str</span>
                            <span class="c1"># and replace missing values with NAK=&#39;\u0015&#39;</span>
                            <span class="c1"># that can be found by `isnan_fast_safe`</span>
                            <span class="c1"># This is done for compatability and likely ruins performance</span>
                            <span class="n">arg_value_array_</span> <span class="o">=</span> <span class="n">arg_value_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;unicode&quot;</span><span class="p">)</span>
                            <span class="n">arg_value_array_</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">arg_value_array</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\u0015</span><span class="s2">&quot;</span>
                            <span class="n">arg_value_array</span> <span class="o">=</span> <span class="n">arg_value_array_</span>
                        <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_value_array</span><span class="p">)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>
                <span class="c1"># else:</span>
                <span class="c1">#     kwargs[&#39;dtype&#39;] = np.float64</span>
                <span class="k">if</span> <span class="n">dot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dotarray&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dot</span>
                <span class="c1"># logger.debug(f&quot;load_raw calling runner with {assembled_args.shape=}, {assembled_inputs.shape=}&quot;)</span>
                <span class="k">return</span> <span class="n">runner_</span><span class="p">(</span><span class="o">*</span><span class="n">assembled_args</span><span class="p">,</span> <span class="o">*</span><span class="n">arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">nb</span><span class="o">.</span><span class="n">TypingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">_raw_functions</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_raw_functions&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nb.TypingError in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_raw_functions</span><span class="p">)</span><span class="si">}</span><span class="s2"> functions&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_raw_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;NameError:&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="kn">import</span> <span class="nn">re</span>

                    <span class="n">problem</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;NameError: (.*)</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">problem</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">err</span>
                    <span class="n">problem</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;NameError: (.*)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">problem</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">err</span>
                <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># raise the inner key error which is more helpful</span>
                <span class="n">context</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">&quot;__context__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">context</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">_iload_raw</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">rg</span><span class="p">,</span>
        <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mnl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pick_counted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">logsums</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nesting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rg</span><span class="p">,</span> <span class="n">DataTree</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
                <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">nb</span><span class="o">.</span><span class="n">NumbaExperimentalFeatureWarning</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">known_arg_names</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;dtype&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dotarray&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;argshape&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;random_draws&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pick_counted&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;logsums&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;choice_dtype&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pick_count_dtype&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;mask&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="n">runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mnl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nesting</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">dot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">runner_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imnl_plus1d</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">runner_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imnl</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">runner_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inestedlogit</span>
                            <span class="n">known_arg_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;n_nodes&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;n_alts&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;edges_up&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;edges_dn&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;mu_params&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;start_slots&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;len_slots&quot;</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                    <span class="k">elif</span> <span class="n">dot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">runner_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_irunner</span>
                        <span class="n">known_arg_names</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;mask&quot;</span><span class="p">})</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;cannot use mask unless dtype is float&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">runner_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idotter</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">runner_</span> <span class="o">=</span> <span class="n">runner</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fullargspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">runner_</span><span class="o">.</span><span class="n">py_func</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">fullargspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">runner_</span><span class="p">)</span>
                <span class="n">named_args</span> <span class="o">=</span> <span class="n">fullargspec</span><span class="o">.</span><span class="n">args</span>
                <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">_arguments_names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">named_args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">known_arg_names</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">argument</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">get_named_array</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="c1"># aux_vars get passed through as is, not forced to be arrays</span>
                    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__aux_var&quot;</span><span class="p">):</span>
                        <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">argument</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span><span class="p">:</span>
                            <span class="c1"># convert object arrays to unicode str</span>
                            <span class="c1"># and replace missing values with NAK=&#39;\u0015&#39;</span>
                            <span class="c1"># that can be found by `isnan_fast_safe`</span>
                            <span class="c1"># This is done for compatability and likely ruins performance</span>
                            <span class="n">argument_</span> <span class="o">=</span> <span class="n">argument</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;unicode&quot;</span><span class="p">)</span>
                            <span class="n">argument_</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">argument</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\u0015</span><span class="s2">&quot;</span>
                            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">argument_</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">argument</span><span class="p">))</span>
                    <span class="n">_arguments_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>
                <span class="k">if</span> <span class="n">dot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dotarray&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dot</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mnl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;random_draws&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mnl</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;pick_counted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pick_counted</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;logsums&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logsums</span>
                <span class="k">if</span> <span class="n">nesting</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">nesting</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;edges_1st&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># unused in simple NL</span>
                    <span class="n">nesting</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;edges_alloc&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># unused in simple NL</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nesting</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_root_node_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tree_root_dims</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tree_root_dims</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">with_root_node_name</span><span class="p">][</span>
                        <span class="s2">&quot;dataset&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">dims</span>
                <span class="n">argshape</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">tree_root_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">presorted</span><span class="p">(</span><span class="n">tree_root_dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="n">mnl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">nesting</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">n_alts</span> <span class="o">=</span> <span class="n">nesting</span><span class="p">[</span><span class="s2">&quot;n_alts&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">argshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">n_alts</span> <span class="o">=</span> <span class="n">argshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">n_alts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;dotarray&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">n_alts</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;choice_dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int8</span>
                    <span class="k">elif</span> <span class="n">n_alts</span> <span class="o">&lt;</span> <span class="mi">32768</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;choice_dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int16</span>
                <span class="k">if</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;========= PASSING ARGUMENT TO SHARROW LOAD ==========&quot;</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">argshape</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_info</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_arguments_names</span><span class="p">,</span> <span class="n">arguments</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARG </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">_info</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">_info</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="n">alt_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_info</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_repr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARG </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alt_repr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ARG </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">: type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_info</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KWARG </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">_info</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">_info</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="n">alt_repr</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_info</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_repr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KWARG </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">alt_repr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KWARG </span><span class="si">{</span><span class="n">_name</span><span class="si">}</span><span class="s2">: type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">_info</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;========= ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ==========&quot;</span>
                    <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">runner_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">argshape</span><span class="p">),</span> <span class="o">*</span><span class="n">arguments</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">compile_watch</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">check_cache_misses</span><span class="p">(</span>
                        <span class="n">runner_</span><span class="p">,</span> <span class="n">log_details</span><span class="o">=</span><span class="n">compile_watch</span> <span class="o">!=</span> <span class="s2">&quot;simple&quot;</span>
                    <span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">except</span> <span class="n">nb</span><span class="o">.</span><span class="n">TypingError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">_raw_functions</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_raw_functions&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nb.TypingError in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">_raw_functions</span><span class="p">)</span><span class="si">}</span><span class="s2"> functions&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_raw_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;NameError:&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="kn">import</span> <span class="nn">re</span>

                    <span class="n">problem</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;NameError: (.*)</span><span class="se">\x1b</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">problem</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">err</span>
                    <span class="n">problem</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;NameError: (.*)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">problem</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="n">problem</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="kn">from</span> <span class="nn">err</span>
                <span class="k">raise</span>
            <span class="c1"># except KeyError as err:</span>
            <span class="c1">#     # raise the inner key error which is more helpful</span>
            <span class="c1">#     context = getattr(err, &quot;__context__&quot;, None)</span>
            <span class="c1">#     if context:</span>
            <span class="c1">#         raise context</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         raise err</span>

    <span class="k">def</span> <span class="nf">check_cache_misses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">funcs</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">log_details</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_recently</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_known_cache_misses&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_known_cache_misses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imnl</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imnl_plus1d</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inestedlogit</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_irunner</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_idotter</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fullargspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">py_func</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">fullargspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">named_args</span> <span class="o">=</span> <span class="n">fullargspec</span><span class="o">.</span><span class="n">args</span>
            <span class="n">cache_misses</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">cache_misses</span>
            <span class="n">runner_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">cache_misses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">runner_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_cache_misses</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_known_cache_misses</span><span class="p">[</span><span class="n">runner_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">fresh</span><span class="p">:</span>
                    <span class="n">known_cache_misses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_cache_misses</span><span class="p">[</span><span class="n">runner_name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">known_cache_misses</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cache_misses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">known_cache_misses</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">log_details</span><span class="p">:</span>
                            <span class="n">warning_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot; - </span><span class="si">{</span><span class="n">argname</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="k">for</span> <span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">argname</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">named_args</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="n">warning_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">runner_name</span><span class="si">}</span><span class="s2">(</span><span class="se">\n</span><span class="si">{</span><span class="n">warning_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">)&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">warning_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">timers</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">overloads</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;timers&quot;</span><span class="p">]</span>
                            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;compiler_lock&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timers</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">timers</span> <span class="o">&lt;</span> <span class="mf">1e-3</span><span class="p">:</span>
                                <span class="n">timers</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timers</span><span class="o">/</span><span class="mf">1e-6</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2"> s&quot;</span>
                            <span class="k">elif</span> <span class="n">timers</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">timers</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timers</span><span class="o">/</span><span class="mf">1e-3</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> ms&quot;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">timers</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">timers</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> s&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;cache miss in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="si">}{</span><span class="n">warning_text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Compile Time: </span><span class="si">{</span><span class="n">timers</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">flow_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">CacheMissWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">1</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_recently</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_known_cache_misses</span><span class="p">[</span><span class="n">runner_name</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_recently</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cache_misses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dict[str, dict]: Numba cache misses across all defined flow methods.&quot;&quot;&quot;</span>
        <span class="n">misses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="kn">from</span> <span class="nn">numba.core.dispatcher</span> <span class="kn">import</span> <span class="n">Dispatcher</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Dispatcher</span><span class="p">):</span>
                <span class="n">misses</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">cache_misses</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">misses</span>

    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">as_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">as_dataarray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">as_table</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">runner</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">logit_draws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pick_counted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">logsums</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">nesting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the flow outputs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        as_dataframe : bool, default False</span>
<span class="sd">            Return the loaded data as a pandas.DataFrame. Must not be used in</span>
<span class="sd">            conjunction with the `dot` argument.</span>
<span class="sd">        as_dataarray : bool, default False</span>
<span class="sd">            Return the loaded data as a xarray.DataArray.</span>
<span class="sd">        as_table : bool, default False</span>
<span class="sd">            Return the loaded data as a sharrow.Table (a subclass of pyarrow.Table).</span>
<span class="sd">        runner : Callable, optional</span>
<span class="sd">            Overload the prepared function with a different callable. Recommended</span>
<span class="sd">            for advanced usage only.</span>
<span class="sd">        dtype : str or dtype</span>
<span class="sd">            Override the default dtype for the result. May trigger re-compilation</span>
<span class="sd">            of the underlying code.</span>
<span class="sd">        dot : array-like, optional</span>
<span class="sd">            An array of coefficients. If provided, the function returns the</span>
<span class="sd">            dot-product of the computed expressions and this array of coefficients,</span>
<span class="sd">            but without ever materializing the array of computed expression values</span>
<span class="sd">            in memory, achiving significant performance gains.</span>
<span class="sd">        logit_draws : array-like, optional</span>
<span class="sd">            An array of random values in the unit interval. If provided, `dot` must</span>
<span class="sd">            also be provided. The dot-product is treated as the utility function</span>
<span class="sd">            for a multinomial logit model, and these draws are used to simulate</span>
<span class="sd">            choices from the implied probabilities.</span>
<span class="sd">        compile_watch : bool, default False</span>
<span class="sd">            Watch for compiled code.</span>
<span class="sd">        logsums : int, default 0</span>
<span class="sd">            Set to 1 to return only logsums instead of making draws from logit models.</span>
<span class="sd">            Set to 2 to return both logsums and draws.</span>
<span class="sd">        nesting : dict, optional</span>
<span class="sd">            Nesting arrays</span>
<span class="sd">        mask : array-like, optional</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">compile_watch</span><span class="p">:</span>
            <span class="n">compile_watch</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">as_dataframe</span> <span class="ow">or</span> <span class="n">as_table</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot format output other than as array if using dot&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">dot</span><span class="o">.</span><span class="n">dtype</span>

        <span class="k">if</span> <span class="n">logit_draws</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">logsums</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logit_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_root_node_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">presorted</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_dims</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="n">presorted</span><span class="p">(</span>
                    <span class="n">source</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">with_root_node_name</span><span class="p">][</span><span class="s2">&quot;dataset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">logit_draws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">if</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">while</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span><span class="p">:</span>
                    <span class="n">logit_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">logit_draws</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logit_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">logit_draws</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">result_dims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">result_squeeze</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># returning extracted raw data, with all dims plus expressions</span>
            <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;expressions&quot;</span><span class="p">]</span>
            <span class="n">result_squeeze</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                <span class="n">dot_trailing_dim</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ALT_COL&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dot_trailing_dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">dot</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">logit_draws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># returning a dot-product for idca-type data</span>
                <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span>
                <span class="n">result_squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
            <span class="k">elif</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">logit_draws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># returning a dot-product for idco-type data</span>
                <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span> <span class="o">+</span> <span class="n">dot_trailing_dim</span>
                <span class="n">result_squeeze</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">logit_draws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># returning a logit model result</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">logit_draws</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
                    <span class="n">logit_draws_trailing_dim</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DRAW&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logit_draws_trailing_dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">logit_draws</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">):</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logit_draws_trailing_dim</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">dot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">result_squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">dot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logit_draws_trailing_dim</span>
                <span class="k">elif</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">):</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dot_trailing_dim</span>
                <span class="k">elif</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">logit_draws_trailing_dim</span>
                    <span class="k">if</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">result_squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span>
                    <span class="n">result_squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span> <span class="o">+</span> <span class="n">logit_draws_trailing_dim</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="c1"># logsums only</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span>
                    <span class="n">result_squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="p">):</span>
                    <span class="c1"># wide choices</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span> <span class="o">+</span> <span class="n">logit_draws_trailing_dim</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="n">logit_draws</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="p">):</span>
                    <span class="c1"># wide choices</span>
                    <span class="n">result_dims</span> <span class="o">=</span> <span class="n">use_dims</span>
                    <span class="n">result_squeeze</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dot</span><span class="o">.</span><span class="n">ndim</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">logit_draws</span><span class="o">.</span><span class="n">ndim</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">use_dims</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_logit_ndims</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

        <span class="c1"># dot_collapse = False</span>
        <span class="n">result_p</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pick_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">out_logsum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dot</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># dot_collapse = True</span>
        <span class="c1"># mnl_collapse = False</span>
        <span class="c1"># idca_collapse = False</span>
        <span class="c1"># if logit_draws is not None and logit_draws.ndim == 1:</span>
        <span class="c1">#     logit_draws = np.expand_dims(logit_draws, -1)</span>
        <span class="c1">#     mnl_collapse = True</span>
        <span class="c1"># elif (</span>
        <span class="c1">#     logit_draws is not None</span>
        <span class="c1">#     and logit_draws.ndim == 2</span>
        <span class="c1">#     and dot.ndim == 2</span>
        <span class="c1">#     and dot.shape[1] == 1</span>
        <span class="c1"># ):</span>
        <span class="c1">#     idca_collapse = True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="o">.</span><span class="n">relationships_are_digitized</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">digitize_relationships</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">relationships_are_digitized</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">logit_draws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iload_raw</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span>
                    <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">dot</span><span class="o">=</span><span class="n">dot</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                    <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">result_p</span><span class="p">,</span> <span class="n">pick_count</span><span class="p">,</span> <span class="n">out_logsum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iload_raw</span><span class="p">(</span>
                    <span class="n">source</span><span class="p">,</span>
                    <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">dot</span><span class="o">=</span><span class="n">dot</span><span class="p">,</span>
                    <span class="n">mnl</span><span class="o">=</span><span class="n">logit_draws</span><span class="p">,</span>
                    <span class="n">pick_counted</span><span class="o">=</span><span class="n">pick_counted</span><span class="p">,</span>
                    <span class="n">logsums</span><span class="o">=</span><span class="n">logsums</span><span class="p">,</span>
                    <span class="n">nesting</span><span class="o">=</span><span class="n">nesting</span><span class="p">,</span>
                    <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
                    <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">pick_count</span> <span class="o">=</span> <span class="n">zero_size_to_None</span><span class="p">(</span><span class="n">pick_count</span><span class="p">)</span>
                <span class="n">out_logsum</span> <span class="o">=</span> <span class="n">zero_size_to_None</span><span class="p">(</span><span class="n">out_logsum</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;please digitize&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">as_dataframe</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">root_dataset</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">as_table</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
                <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">result</span><span class="p">[:,</span> <span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">as_dataarray</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">result_squeeze</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">result_squeeze</span><span class="p">)</span>
                <span class="n">result_p</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">result_p</span><span class="p">,</span> <span class="n">result_squeeze</span><span class="p">)</span>
                <span class="n">pick_count</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">pick_count</span><span class="p">,</span> <span class="n">result_squeeze</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_root_node_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result_coords</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result_dims</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result_coords</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">with_root_node_name</span><span class="p">][</span>
                        <span class="s2">&quot;dataset&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result_dims</span>
                <span class="p">}</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span>
                    <span class="n">dims</span><span class="o">=</span><span class="n">result_dims</span><span class="p">,</span>
                    <span class="n">coords</span><span class="o">=</span><span class="n">result_coords</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;expressions&quot;</span> <span class="ow">in</span> <span class="n">result_dims</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="s2">&quot;expressions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_names</span>
            <span class="k">if</span> <span class="n">result_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">result_p</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">result_p</span><span class="p">,</span>
                    <span class="n">dims</span><span class="o">=</span><span class="n">result_dims</span><span class="p">,</span>
                    <span class="n">coords</span><span class="o">=</span><span class="n">result_coords</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">pick_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pick_count</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">pick_count</span><span class="p">,</span>
                    <span class="n">dims</span><span class="o">=</span><span class="n">result_dims</span><span class="p">,</span>
                    <span class="n">coords</span><span class="o">=</span><span class="n">result_coords</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">out_logsum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out_logsum</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">out_logsum</span><span class="p">,</span>
                    <span class="n">dims</span><span class="o">=</span><span class="n">result_dims</span><span class="p">[:</span> <span class="n">out_logsum</span><span class="o">.</span><span class="n">ndim</span><span class="p">],</span>
                    <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
                        <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result_dims</span><span class="p">[:</span> <span class="n">out_logsum</span><span class="o">.</span><span class="n">ndim</span><span class="p">]</span>
                    <span class="p">},</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result_squeeze</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">result_squeeze</span><span class="p">)</span>
                <span class="n">result_p</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">result_p</span><span class="p">,</span> <span class="n">result_squeeze</span><span class="p">)</span>
                <span class="n">pick_count</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="n">pick_count</span><span class="p">,</span> <span class="n">result_squeeze</span><span class="p">)</span>

        <span class="c1"># if compile_watch:</span>
        <span class="c1">#     self.compiled_recently = False</span>
        <span class="c1">#     for i in os.walk(os.path.join(self.cache_dir, self.name)):</span>
        <span class="c1">#         for f in i[2]:</span>
        <span class="c1">#             fi = os.path.join(i[0], f)</span>
        <span class="c1">#             try:</span>
        <span class="c1">#                 t = os.path.getmtime(fi)</span>
        <span class="c1">#             except FileNotFoundError:</span>
        <span class="c1">#                 # something is actively happening in this directory</span>
        <span class="c1">#                 self.compiled_recently = True</span>
        <span class="c1">#                 logger.warning(</span>
        <span class="c1">#                     f&quot;unidentified activity (file deletion) detected for {self.name}&quot;</span>
        <span class="c1">#                 )</span>
        <span class="c1">#                 break</span>
        <span class="c1">#             if t &gt; compile_watch:</span>
        <span class="c1">#                 self.compiled_recently = True</span>
        <span class="c1">#                 logger.warning(f&quot;compilation activity detected for {self.name}&quot;)</span>
        <span class="c1">#                 break</span>
        <span class="c1">#         if self.compiled_recently:</span>
        <span class="c1">#             break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">compile_watch</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_recently</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">out_logsum</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">result_p</span><span class="p">,</span> <span class="n">pick_count</span><span class="p">,</span> <span class="n">out_logsum</span>
        <span class="k">if</span> <span class="n">pick_count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">result_p</span><span class="p">,</span> <span class="n">pick_count</span>
        <span class="k">if</span> <span class="n">result_p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">result_p</span>
        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="Flow.load"><a class="viewcode-back" href="../../api.html#sharrow.Flow.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the flow outputs as a numpy array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        dtype : str or dtype</span>
<span class="sd">            Override the default dtype for the result. May trigger re-compilation</span>
<span class="sd">            of the underlying code.</span>
<span class="sd">        compile_watch : bool, default False</span>
<span class="sd">            Set the `compiled_recently` flag on this flow to True if any file</span>
<span class="sd">            modification activity is observed in the cache directory.</span>
<span class="sd">        mask : array-like, optional</span>
<span class="sd">            Only compute values for items where mask is truthy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Flow.load_dataframe"><a class="viewcode-back" href="../../api.html#sharrow.Flow.load_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">load_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the flow outputs as a pandas.DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        dtype : str or dtype</span>
<span class="sd">            Override the default dtype for the result. May trigger re-compilation</span>
<span class="sd">            of the underlying code.</span>
<span class="sd">        compile_watch : bool, default False</span>
<span class="sd">            Set the `compiled_recently` flag on this flow to True if any file</span>
<span class="sd">            modification activity is observed in the cache directory.</span>
<span class="sd">        mask : array-like, optional</span>
<span class="sd">            Only compute values for items where mask is truthy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">as_dataframe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Flow.load_dataarray"><a class="viewcode-back" href="../../api.html#sharrow.Flow.load_dataarray">[docs]</a>    <span class="k">def</span> <span class="nf">load_dataarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the flow outputs as a xarray.DataArray.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        dtype : str or dtype</span>
<span class="sd">            Override the default dtype for the result. May trigger re-compilation</span>
<span class="sd">            of the underlying code.</span>
<span class="sd">        compile_watch : bool, default False</span>
<span class="sd">            Set the `compiled_recently` flag on this flow to True if any file</span>
<span class="sd">            modification activity is observed in the cache directory.</span>
<span class="sd">        mask : array-like, optional</span>
<span class="sd">            Only compute values for items where mask is truthy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">as_dataarray</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Flow.dot"><a class="viewcode-back" href="../../api.html#sharrow.Flow.dot">[docs]</a>    <span class="k">def</span> <span class="nf">dot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the dot-product of expression results and coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coefficients : array-like</span>
<span class="sd">            This function will return the dot-product of the computed expressions</span>
<span class="sd">            and this array of coefficients, but without ever materializing the</span>
<span class="sd">            array of computed expression values in memory, achieving significant</span>
<span class="sd">            performance gains.</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        dtype : str or dtype</span>
<span class="sd">            Override the default dtype for the result. May trigger re-compilation</span>
<span class="sd">            of the underlying code.</span>
<span class="sd">        compile_watch : bool, default False</span>
<span class="sd">            Set the `compiled_recently` flag on this flow to True if any file</span>
<span class="sd">            modification activity is observed in the cache directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">dot</span><span class="o">=</span><span class="n">coefficients</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Flow.dot_dataarray"><a class="viewcode-back" href="../../api.html#sharrow.Flow.dot_dataarray">[docs]</a>    <span class="k">def</span> <span class="nf">dot_dataarray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coefficients</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the dot-product of expression results and coefficients.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coefficients : DataArray</span>
<span class="sd">            This function will return the dot-product of the computed expressions</span>
<span class="sd">            and this array of coefficients, but without ever materializing the</span>
<span class="sd">            array of computed expression values in memory, achieving significant</span>
<span class="sd">            performance gains.</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        dtype : str or dtype</span>
<span class="sd">            Override the default dtype for the result. May trigger re-compilation</span>
<span class="sd">            of the underlying code.</span>
<span class="sd">        compile_watch : bool, default False</span>
<span class="sd">            Set the `compiled_recently` flag on this flow to True if any file</span>
<span class="sd">            modification activity is observed in the cache directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xarray.DataArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span>
            <span class="n">dot</span><span class="o">=</span><span class="n">coefficients</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">as_dataarray</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Flow.logit_draws"><a class="viewcode-back" href="../../api.html#sharrow.Flow.logit_draws">[docs]</a>    <span class="k">def</span> <span class="nf">logit_draws</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coefficients</span><span class="p">,</span>
        <span class="n">draws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pick_counted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">logsums</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">compile_watch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nesting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">as_dataarray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make random simulated choices for a multinomial logit model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coefficients : array-like</span>
<span class="sd">            These coefficients are used is in `dot` to compute the dot-product</span>
<span class="sd">            of the computed expressions, and this result is treated as the utility</span>
<span class="sd">            function for a multinomial logit model.</span>
<span class="sd">        draws : array-like</span>
<span class="sd">            A one or two dimensional array of random values in the unit interval.</span>
<span class="sd">            If one dimensional, then it must have length equal to the first</span>
<span class="sd">            dimension of the base `shape` of `source`, and a single draw will be</span>
<span class="sd">            applied for each row in that dimension.  If two dimensional, the first</span>
<span class="sd">            dimension must match as above, and the second dimension determines the</span>
<span class="sd">            number of draws applied for each row in the first dimension.</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        pick_counted : bool, default False</span>
<span class="sd">            Whether to tally multiple repeated choices with a pick count.</span>
<span class="sd">        logsums : int, default 0</span>
<span class="sd">            Set to 1 to return only logsums instead of making draws from logit models.</span>
<span class="sd">            Set to 2 to return both logsums and draws.</span>
<span class="sd">        dtype : str or dtype</span>
<span class="sd">            Override the default dtype for the probability. May trigger re-compilation</span>
<span class="sd">            of the underlying code.  The choices and pick counts (if included)</span>
<span class="sd">            are always integers.</span>
<span class="sd">        compile_watch : bool, default False</span>
<span class="sd">            Set the `compiled_recently` flag on this flow to True if any file</span>
<span class="sd">            modification activity is observed in the cache directory.</span>
<span class="sd">        nesting : dict, optional</span>
<span class="sd">            Nesting instructions</span>
<span class="sd">        as_dataarray : bool, default False</span>
<span class="sd">        mask : array-like, optional</span>
<span class="sd">            Only compute values for items where mask is truthy.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        choices : array[int32]</span>
<span class="sd">            The positions of the simulated choices.</span>
<span class="sd">        probs : array[dtype]</span>
<span class="sd">            The probability that was associated with each simulated choice.</span>
<span class="sd">        pick_count : array[int32], optional</span>
<span class="sd">            A count of how many times this choice was chosen, only included</span>
<span class="sd">            if `pick_counted` is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">dot</span><span class="o">=</span><span class="n">coefficients</span><span class="p">,</span>
            <span class="n">logit_draws</span><span class="o">=</span><span class="n">draws</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">pick_counted</span><span class="o">=</span><span class="n">pick_counted</span><span class="p">,</span>
            <span class="n">compile_watch</span><span class="o">=</span><span class="n">compile_watch</span><span class="p">,</span>
            <span class="n">logsums</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">(</span><span class="n">logsums</span><span class="p">),</span>
            <span class="n">nesting</span><span class="o">=</span><span class="n">nesting</span><span class="p">,</span>
            <span class="n">as_dataarray</span><span class="o">=</span><span class="n">as_dataarray</span><span class="p">,</span>
            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">defs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">function_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@function_names</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">function_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">_spill</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">all_name_tokens</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">_spill</span><span class="p">(</span><span class="n">all_name_tokens</span><span class="p">)]</span>
        <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output_name_positions = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_name_positions</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;function_names = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">function_names</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

<div class="viewcode-block" id="Flow.show_code"><a class="viewcode-back" href="../../api.html#sharrow.Flow.show_code">[docs]</a>    <span class="k">def</span> <span class="nf">show_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="s2">&quot;inline&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display the underlying Python code constructed for this flow.</span>

<span class="sd">        This convenience function is provided primarily to display the underlying</span>
<span class="sd">        source code in a Jupyter notebook, for debugging and educational purposes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        linenos : {&#39;inline&#39;, &#39;table&#39;}</span>
<span class="sd">            This argument is passed to the pygments HtmlFormatter.</span>
<span class="sd">            If set to ``&#39;table&#39;``, output line numbers as a table with two cells,</span>
<span class="sd">            one containing the line numbers, the other the whole code.  This is</span>
<span class="sd">            copy-and-paste-friendly, but may cause alignment problems with some</span>
<span class="sd">            browsers or fonts.  If set to ``&#39;inline&#39;``, the line numbers will be</span>
<span class="sd">            integrated in the ``&lt;pre&gt;`` tag that contains the code.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        IPython.display.HTML</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>
        <span class="kn">from</span> <span class="nn">pygments</span> <span class="kn">import</span> <span class="n">highlight</span>
        <span class="kn">from</span> <span class="nn">pygments.formatters.html</span> <span class="kn">import</span> <span class="n">HtmlFormatter</span>
        <span class="kn">from</span> <span class="nn">pygments.lexers.python</span> <span class="kn">import</span> <span class="n">PythonLexer</span>

        <span class="n">codefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">codefile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_code</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">f_code</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">pretty</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">PythonLexer</span><span class="p">(),</span> <span class="n">HtmlFormatter</span><span class="p">(</span><span class="n">linenos</span><span class="o">=</span><span class="n">linenos</span><span class="p">))</span>
        <span class="n">css</span> <span class="o">=</span> <span class="n">HtmlFormatter</span><span class="p">()</span><span class="o">.</span><span class="n">get_style_defs</span><span class="p">(</span><span class="s2">&quot;.highlight&quot;</span><span class="p">)</span>
        <span class="n">bbedit_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;x-bbedit://open?url=file://</span><span class="si">{</span><span class="n">codefile</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">bb_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;a href=&quot;</span><span class="si">{</span><span class="n">bbedit_url</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="si">{</span><span class="n">codefile</span><span class="si">}</span><span class="s1">&lt;/a&gt;&#39;</span>
        <span class="k">return</span> <span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;style&gt;</span><span class="si">{</span><span class="n">css</span><span class="si">}</span><span class="s2">&lt;/style&gt;&lt;p&gt;</span><span class="si">{</span><span class="n">bb_link</span><span class="si">}</span><span class="s2">&lt;/p&gt;</span><span class="si">{</span><span class="n">pretty</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">init_streamer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a compiled closure on the data for loading individual lines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source : DataTree, optional</span>
<span class="sd">            This is the source of the data for this flow. If not provided, the</span>
<span class="sd">            tree used to initialize this flow is used.</span>
<span class="sd">        dtype : str or dtype, default float32</span>
<span class="sd">            Override the default dtype for the result. May trigger re-compilation</span>
<span class="sd">            of the underlying code.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        callable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

        <span class="n">named_args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_linemaker</span><span class="o">.</span><span class="n">py_func</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">skip_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;intermediate&quot;</span><span class="p">,</span> <span class="s2">&quot;j0&quot;</span><span class="p">,</span> <span class="s2">&quot;j1&quot;</span><span class="p">]</span>
        <span class="n">named_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">named_args</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip_args</span><span class="p">)</span>

        <span class="n">general_mapping</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">subspaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">mangled_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">mangled_key</span> <span class="ow">in</span> <span class="n">named_args</span><span class="p">:</span>
                    <span class="n">general_mapping</span><span class="p">[</span><span class="n">mangled_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
                <span class="n">mangled_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">mangled_key</span> <span class="ow">in</span> <span class="n">named_args</span><span class="p">:</span>
                    <span class="n">general_mapping</span><span class="p">[</span><span class="n">mangled_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">selected_args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">general_mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">named_args</span><span class="p">)</span>
        <span class="n">len_self_raw_functions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_functions</span><span class="p">)</span>
        <span class="n">tree_root_dims</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">root_dataset</span><span class="o">.</span><span class="n">dims</span>
        <span class="n">argshape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">tree_root_dims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">presorted</span><span class="p">(</span><span class="n">tree_root_dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_order</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim_exclude</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">linemaker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linemaker</span>

            <span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
            <span class="k">def</span> <span class="nf">streamer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">len_self_raw_functions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">out</span>
                    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">len_self_raw_functions</span>
                <span class="n">linemaker</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">selected_args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">argshape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">n_alts</span> <span class="o">=</span> <span class="n">argshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">linemaker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linemaker</span>

            <span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
            <span class="k">def</span> <span class="nf">streamer</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_alts</span><span class="p">,</span> <span class="n">len_self_raw_functions</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">out</span>
                    <span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">n_alts</span><span class="p">,</span> <span class="n">len_self_raw_functions</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_alts</span><span class="p">):</span>
                    <span class="n">linemaker</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">selected_args</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;root tree with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">argshape</span><span class="p">)</span><span class="si">}</span><span class="s2"> dims </span><span class="si">{</span><span class="n">argshape</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">streamer</span></div>
</pre></div>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sharrow contributors, for the <a href="https://activitysim.github.io/">ActivitySim Consortium</a>
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
       Copyright 2022 AMPO Research Foundation.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>